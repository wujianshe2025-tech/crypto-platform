<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿½é£è§‚æµ‹ - åŠ å¯†è´§å¸è¡Œæƒ…ä¸é¢„æµ‹å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* å¯¼èˆªæ ä¼˜åŒ– */
            .nav-container {
                flex-direction: column;
                height: auto !important;
                padding: 0.75rem 0;
            }
            
            .nav-logo {
                font-size: 1.125rem !important;
                margin-bottom: 0.5rem;
            }
            
            .nav-buttons {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.25rem;
                width: 100%;
            }
            
            .nav-btn {
                padding: 0.5rem 0.25rem !important;
                font-size: 0.75rem !important;
                text-align: center;
            }
            
            /* ç”¨æˆ·çŠ¶æ€æŒ‰é’® */
            #user-status {
                margin-top: 0.5rem;
                width: 100%;
            }
            
            #user-status button,
            #user-status .user-info {
                width: 100%;
                font-size: 0.875rem !important;
            }
            
            /* é¡µé¢æ ‡é¢˜ */
            h1 {
                font-size: 1.5rem !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
            
            /* å®¹å™¨å†…è¾¹è· */
            .container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            
            main {
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
            
            /* å¡ç‰‡ä¼˜åŒ– */
            .crypto-card {
                padding: 0.75rem !important;
            }
            
            /* æŒ‰é’®ä¼˜åŒ– */
            button {
                font-size: 0.875rem !important;
            }
            
            /* è¡¨å•ä¼˜åŒ– */
            input, textarea, select {
                font-size: 1rem !important;
            }
            
            /* æ¨¡æ€æ¡†ä¼˜åŒ– */
            .modal-content {
                margin: 1rem !important;
                max-width: calc(100% - 2rem) !important;
            }
            
            /* é¢„æµ‹å¡ç‰‡ä¼˜åŒ– */
            .prediction-card {
                padding: 1rem !important;
            }
            
            /* é€‰é¡¹æŒ‰é’®ä¼˜åŒ– */
            .option-count-btn,
            .reward-btn {
                padding: 0.5rem 0.5rem !important;
                font-size: 0.875rem !important;
            }
            
            /* ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
            .stats-card {
                padding: 0.75rem !important;
            }
            
            /* æ–°é—»å¡ç‰‡ä¼˜åŒ– */
            .news-card {
                padding: 0.75rem !important;
            }
            
            /* è¯„è®ºåŒºä¼˜åŒ– */
            .comment-item {
                padding: 0.75rem !important;
            }
            
            /* éšè—ç§»åŠ¨ç«¯ä¸å¿…è¦çš„å…ƒç´  */
            .hide-mobile {
                display: none !important;
            }
        }
        
        /* å¹³æ¿ä¼˜åŒ– */
        @media (min-width: 769px) and (max-width: 1024px) {
            .nav-btn {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.875rem !important;
            }
            
            .container {
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }
        }
        
        /* è§¦æ‘¸ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            button, a {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4">
            <div class="nav-container flex items-center justify-between h-16">
                <div class="flex flex-col md:flex-row items-center md:space-x-8 w-full md:w-auto">
                    <div class="nav-logo text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text" style="background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ğŸŒªï¸ è¿½é£è§‚æµ‹</div>
                    <div class="nav-buttons flex space-x-1 mt-2 md:mt-0">
                        <button onclick="showPage('market', event)" class="nav-btn px-4 py-2 rounded hover:bg-gray-700">ğŸ“Š è¡Œæƒ…</button>
                        <button onclick="showPage('news', event)" class="nav-btn px-4 py-2 rounded hover:bg-gray-700">ğŸ“° æ–°é—»</button>
                        <button onclick="showPage('calendar', event)" class="nav-btn px-4 py-2 rounded hover:bg-gray-700">ğŸ“… æ—¥å†</button>
                        <button onclick="showPage('community', event)" class="nav-btn px-4 py-2 rounded hover:bg-gray-700">ğŸ’¬ ç¤¾åŒº</button>
                        <button onclick="showPage('predictions', event)" class="nav-btn px-4 py-2 rounded hover:bg-gray-700">ğŸ¯ é¢„æµ‹</button>
                    </div>
                </div>
                <div id="user-status" class="mt-2 md:mt-0">
                    <button onclick="showLoginModal()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition text-sm">
                        ç™»å½• / æ³¨å†Œ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <!-- è¡Œæƒ…é¡µé¢ -->
        <div id="market-page" class="page">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-3xl font-bold">å®æ—¶è¡Œæƒ…</h1>
                <div class="flex items-center space-x-2 text-sm text-gray-400">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span>å®æ—¶æ›´æ–°ä¸­</span>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg overflow-hidden shadow-xl">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-gray-700 to-gray-800">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">å¸ç§</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">æœ€æ–°ä»·æ ¼</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">24hæ¶¨è·Œ</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">å¸‚å€¼</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">æˆäº¤é‡</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">çˆ†ä»“é‡(24h)</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">æŒä»“é‡(OI)</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">24hæœ€é«˜/æœ€ä½</th>
                        </tr>
                    </thead>
                    <tbody id="crypto-table"></tbody>
                </table>
            </div>
            <div id="crypto-source-note" class="mt-6 text-sm text-gray-400">æ•°æ®æ¥æºï¼šOKX / Binance å…¬å…±æ¥å£</div>
            <div class="mt-6 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                <p class="text-sm text-green-300">âœ… <strong>çœŸå®æ•°æ®ï¼š</strong>ä»·æ ¼æ•°æ®æ¥è‡ª CoinGecko APIï¼Œæ¯30ç§’è‡ªåŠ¨æ›´æ–°</p>
            </div>
        </div>

        <!-- æ–°é—»é¡µé¢ -->
        <div id="news-page" class="page hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <h1 class="text-2xl font-bold">æ–°é—»</h1>
                </div>
                <div id="news-date-time" class="flex items-center space-x-2">
                    <span class="text-sm text-gray-300"></span>
                    <span class="px-3 py-1 bg-blue-900/40 text-blue-400 rounded-md text-sm font-mono tabular-nums"></span>
                </div>
            </div>
            <!-- é¡¶éƒ¨æ ‡ç­¾æ  -->
            <div class="flex items-center space-x-6 mb-6 border-b border-gray-700">
                <button onclick="filterNews('', event)" class="news-tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-blue-500 text-blue-500">
                    ä»Šå¤©
                </button>
                <button onclick="filterNews('realtime', event)" class="news-tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-white">
                    å¿«è®¯
                </button>
                <button onclick="filterNews('important', event)" class="news-tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-white">
                    æ·±åº¦
                </button>
            </div>

            <!-- æ–°é—»åˆ—è¡¨ - æ—¶é—´çº¿å¼å¸ƒå±€ -->
            <div class="bg-gray-800 rounded-lg">
                <div id="news-list" class="divide-y divide-gray-700"></div>
            </div>

            <!-- åŠ è½½æ›´å¤š -->
            <div class="mt-6 text-center">
                <button onclick="loadMoreNews()" class="px-6 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">
                    åŠ è½½æ›´å¤š
                </button>
            </div>
        </div>

        <!-- æ•°æ®æ—¥å†é¡µé¢ -->
        <div id="calendar-page" class="page hidden">
            <!-- é¡¶éƒ¨ç­›é€‰æ  -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold">ç»æµæ•°æ®</h1>
                    <div class="flex space-x-2">
                        <button onclick="filterCalendar('all', event)" class="calendar-filter-btn px-4 py-2 rounded bg-blue-600 text-sm">å…¨éƒ¨</button>
                        <button onclick="filterCalendar('important', event)" class="calendar-filter-btn px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm">é‡è¦</button>
                        <button onclick="filterCalendar('today', event)" class="calendar-filter-btn px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm">ä»Šå¤©</button>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="changeCalendarDate(-7)" class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 text-sm">ä¸Šä¸€å‘¨</button>
                    <button onclick="changeCalendarDate(-1)" class="p-2 bg-gray-700 rounded hover:bg-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div id="calendar-date-display" class="px-4 py-2 bg-gray-700 rounded text-sm font-semibold">2025-11-27</div>
                    <button onclick="changeCalendarDate(1)" class="p-2 bg-gray-700 rounded hover:bg-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <button onclick="changeCalendarDate(7)" class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 text-sm">ä¸‹ä¸€å‘¨</button>
                    <button onclick="setCalendarToday()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 text-sm font-semibold">ä»Šå¤©</button>
                </div>
            </div>

            <!-- æ—¥æœŸå¿«æ·é€‰æ‹© -->
            <div class="mb-6 bg-gray-800 rounded-lg p-4">
                <div id="calendar-week-tabs" class="flex space-x-2 overflow-x-auto"></div>
            </div>

            <!-- é«˜çº§ç­›é€‰ -->
            <div class="mb-4 flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-400">é‡è¦æ€§</span>
                    <select id="calendar-importance-select" class="bg-gray-700 rounded px-2 py-1 text-sm" onchange="onCalendarImportanceChange(event)">
                        <option value="1">å…¨éƒ¨</option>
                        <option value="3">ä¸­åº¦åŠä»¥ä¸Š</option>
                        <option value="4">é‡è¦åŠä»¥ä¸Š</option>
                        <option value="5">éå¸¸é‡è¦</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-400">å›½å®¶</span>
                    <select id="calendar-country-select" class="bg-gray-700 rounded px-2 py-1 text-sm" onchange="onCalendarCountryChange(event)">
                        <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-400">ç±»å‹</span>
                    <select id="calendar-type-select" class="bg-gray-700 rounded px-2 py-1 text-sm" onchange="onCalendarTypeChange(event)">
                        <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                        <option value="CPI">CPI</option>
                        <option value="PPI">PPI</option>
                        <option value="GDP">GDP</option>
                        <option value="PMI">PMI</option>
                        <option value="å°±ä¸š">å°±ä¸š</option>
                        <option value="åˆ©ç‡">åˆ©ç‡</option>
                        <option value="é›¶å”®">é›¶å”®</option>
                        <option value="è´¸æ˜“">è´¸æ˜“</option>
                    </select>
                </div>
            </div>

            <div id="calendar-day-summary" class="mb-4 bg-gray-800 rounded-lg p-4 text-sm text-gray-300"></div>

            <!-- æ•°æ®åˆ—è¡¨ -->
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <!-- è¡¨å¤´ -->
                <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-gray-700 text-sm font-semibold text-gray-300 border-b border-gray-600">
                    <div class="col-span-1">æ—¶é—´</div>
                    <div class="col-span-1">æ•°æ®</div>
                    <div class="col-span-3">äº‹ä»¶</div>
                    <div class="col-span-1 text-center">é‡è¦æ€§</div>
                    <div class="col-span-1 text-right">å‰å€¼</div>
                    <div class="col-span-1 text-right">é¢„æµ‹å€¼</div>
                    <div class="col-span-1 text-right">å…¬å¸ƒå€¼</div>
                    <div class="col-span-2 text-center">å½±å“</div>
                    <div class="col-span-1 text-center">æé†’</div>
                </div>
                
                <!-- æ•°æ®è¡Œ -->
                <div id="calendar-events-list" class="divide-y divide-gray-700"></div>
            </div>

            <!-- æ•°æ®è¯´æ˜ -->
            <div class="mt-6 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                <p class="text-sm text-blue-300">
                    <strong>ğŸ“Š æ•°æ®æ¥æºï¼š</strong>ç»æµæ•°æ®æ¥è‡ªä¸»è¦å›½å®¶å¤®è¡Œå’Œç»Ÿè®¡æœºæ„ï¼Œæ¯æ—¥æ›´æ–°ã€‚
                    <span class="ml-4"><strong>â­ é‡è¦æ€§ï¼š</strong>æ˜Ÿçº§è¶Šé«˜ï¼Œå¯¹å¸‚åœºå½±å“è¶Šå¤§ã€‚</span>
                    <span class="ml-4"><strong>ğŸ“ˆ å½±å“ï¼š</strong>åˆ©å¤šè¡¨ç¤ºå¯èƒ½æ¨åŠ¨å¸‚åœºä¸Šæ¶¨ï¼Œåˆ©ç©ºè¡¨ç¤ºå¯èƒ½å¯¼è‡´ä¸‹è·Œã€‚</span>
                </p>
            </div>
        </div>

        <!-- ç¤¾åŒºé¡µé¢ -->
        <div id="community-page" class="page hidden">
            <h1 class="text-3xl font-bold mb-8">ç¤¾åŒºè®ºå›</h1>
            <div class="bg-gray-800 rounded-lg p-6 mb-8">
                <textarea id="new-post" placeholder="åˆ†äº«ä½ çš„è§‚ç‚¹..." class="w-full bg-gray-700 rounded-lg p-4 text-white resize-none" rows="4"></textarea>
                <div class="flex justify-end mt-4">
                    <button onclick="createPost()" class="px-6 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">å‘å¸ƒ</button>
                </div>
            </div>
            <div id="posts-list" class="space-y-6"></div>
        </div>

        <!-- é¢„æµ‹é¡µé¢ -->
        <div id="predictions-page" class="page hidden">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold mb-2">é¢„æµ‹æŠ•ç¥¨</h1>
                    <p class="text-gray-400 text-sm">å‚ä¸é¢„æµ‹ï¼Œèµ¢å–å¥–åŠ± ğŸ¯</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="prediction-member-status" class="text-sm">
                        <!-- ä¼šå‘˜çŠ¶æ€å°†é€šè¿‡ JavaScript åŠ¨æ€æ›´æ–° -->
                    </div>
                    <button onclick="showPredictionTypeModal()" class="px-6 py-2 bg-gradient-to-r from-green-600 to-teal-600 rounded-lg hover:from-green-700 hover:to-teal-700 font-semibold shadow-lg">+ å‘èµ·é¢„æµ‹</button>
                </div>
            </div>
            
            <!-- ç”¨æˆ·æƒé™æç¤º -->
            <div id="prediction-notice" class="mb-6">
                <!-- æƒé™æç¤ºå°†é€šè¿‡ JavaScript åŠ¨æ€æ›´æ–° -->
            </div>

            <!-- å¹³å°æ¿€åŠ±åŸºé‡‘ -->
            <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-500/50 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-3xl">ğŸ†</span>
                        <div>
                            <div class="font-semibold text-purple-400 mb-1">å¹³å°æ¿€åŠ±åŸºé‡‘</div>
                            <div class="text-sm text-gray-300">æ¯å‘¨å‘æ”¾ç»™æ´»è·ƒè´¡çŒ®ç”¨æˆ·</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-purple-400" id="platform-fund">0 USDT</div>
                        <div class="text-xs text-gray-400">ä¸‹æ¬¡å‘æ”¾ï¼šå‘¨æ—¥</div>
                    </div>
                </div>
            </div>

            <div id="create-prediction" class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 mb-8 hidden border border-gray-700 shadow-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="text-2xl mr-2">ğŸ¯</span> åˆ›å»ºæ–°é¢„æµ‹
                </h2>
                
                <!-- ä»Šæ—¥å‘èµ·ç»Ÿè®¡ -->
                <div id="prediction-stats" class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 mb-4 text-sm">
                    <!-- ç»Ÿè®¡ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ¨æ€æ›´æ–° -->
                </div>

                <input id="pred-title" type="text" placeholder="ä¾‹å¦‚ï¼šç‰¹æœ—æ™®å…ˆç”Ÿä»Šå¤©æˆ´ä»€ä¹ˆé¢œè‰²çš„é¢†å¸¦ï¼Ÿ" class="w-full bg-gray-700 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <textarea id="pred-desc" placeholder="é¢„æµ‹æè¿°ï¼ˆå¯é€‰ï¼‰" class="w-full bg-gray-700 rounded-lg p-3 text-white resize-none mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3"></textarea>
                
                <!-- é¢„æµ‹ç±»å‹åˆ‡æ¢ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">é¢„æµ‹ç±»å‹</label>
                    <div class="flex space-x-2">
                        <button id="free-type-btn" onclick="switchPredictionType('free')" class="flex-1 py-2 bg-blue-600 rounded-lg text-sm font-semibold">
                            ğŸ¯ æ— å¥–é¢„æµ‹
                        </button>
                        <button id="reward-type-btn" onclick="switchPredictionType('reward')" class="flex-1 py-2 bg-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-600">
                            ğŸ’° æœ‰å¥–é¢„æµ‹
                        </button>
                    </div>
                </div>
                
                <!-- æŠ•ç¥¨é€‰é¡¹è®¾ç½® -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">æŠ•ç¥¨é€‰é¡¹æ•°é‡</label>
                    <div class="flex space-x-2">
                        <button onclick="setOptionCount(2)" class="option-count-btn flex-1 py-2 bg-blue-600 rounded-lg text-sm font-semibold">2ä¸ª</button>
                        <button onclick="setOptionCount(3)" class="option-count-btn flex-1 py-2 bg-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-600">3ä¸ª</button>
                        <button onclick="setOptionCount(4)" class="option-count-btn flex-1 py-2 bg-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-600">4ä¸ª</button>
                        <button onclick="setOptionCount(5)" class="option-count-btn flex-1 py-2 bg-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-600">5ä¸ª</button>
                    </div>
                </div>
                
                <!-- é€‰é¡¹è¾“å…¥æ¡†å®¹å™¨ -->
                <div id="options-container" class="mb-4">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„é€‰é¡¹è¾“å…¥æ¡† -->
                </div>
                
                <!-- å¥–é‡‘è®¾ç½®ï¼ˆä»…æœ‰å¥–é¢„æµ‹æ˜¾ç¤ºï¼‰ -->
                <div id="reward-settings-container" class="bg-gray-700 rounded-lg p-4 mb-4" style="display: none;">
                    <div class="flex items-center justify-between mb-3">
                        <label class="font-semibold">å¥–é‡‘è®¾ç½®</label>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">æ¯äººæŠ•æ³¨é‡‘é¢ï¼ˆUSDTï¼‰</label>
                            <div class="flex space-x-2">
                                <button onclick="setRewardAmount(1)" class="reward-btn flex-1 px-4 py-2 bg-gray-600 rounded hover:bg-blue-600 transition">1</button>
                                <button onclick="setRewardAmount(2)" class="reward-btn flex-1 px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 transition">2</button>
                                <button onclick="setRewardAmount(3)" class="reward-btn flex-1 px-4 py-2 bg-gray-600 rounded hover:bg-blue-600 transition">3</button>
                                <button onclick="setRewardAmount(4)" class="reward-btn flex-1 px-4 py-2 bg-gray-600 rounded hover:bg-blue-600 transition">4</button>
                                <button onclick="setRewardAmount(5)" class="reward-btn flex-1 px-4 py-2 bg-gray-600 rounded hover:bg-blue-600 transition">5</button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3 text-xs space-y-1">
                            <div class="flex justify-between text-gray-400">
                                <span>å¥–é‡‘åˆ†é…è§„åˆ™ï¼š</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">â€¢ èƒœå‡ºæ–¹è·å¾—</span>
                                <span class="text-green-400 font-semibold">90%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">â€¢ å‘èµ·è€…è·å¾—</span>
                                <span class="text-yellow-400 font-semibold">1%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">â€¢ å¹³å°æ¿€åŠ±åŸºé‡‘</span>
                                <span class="text-blue-400 font-semibold">4%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">â€¢ å¹³å°è¿è¥è´¹</span>
                                <span class="text-purple-400 font-semibold">5%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button onclick="createPrediction()" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg hover:from-blue-700 hover:to-purple-700 font-semibold shadow-lg">åˆ›å»ºé¢„æµ‹</button>
                    <button onclick="toggleCreatePrediction()" class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600">å–æ¶ˆ</button>
                </div>
            </div>
            <div id="predictions-list" class="space-y-6"></div>
        </div>

        <!-- ç™»å½•æ³¨å†Œå¼¹çª— -->
        <div id="auth-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50" style="display: none;">
            <div class="bg-gray-800 rounded-xl p-8 max-w-md mx-4 shadow-2xl border border-gray-700">
                <!-- ç™»å½•è¡¨å• -->
                <div id="login-form">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold mb-2">ç™»å½•è´¦å·</h2>
                        <p class="text-gray-400 text-sm">ç™»å½•åå¯å‚ä¸ç¤¾åŒºäº’åŠ¨å’Œé¢„æµ‹æŠ•ç¥¨</p>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                            <input id="login-username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" 
                                class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">å¯†ç </label>
                            <input id="login-password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " 
                                class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <button onclick="handleLogin()" class="w-full px-6 py-3 bg-blue-600 rounded-lg hover:bg-blue-700 font-semibold mb-3">
                        ç™»å½•
                    </button>
                    
                    <div class="text-center text-sm text-gray-400">
                        è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ
                        <button onclick="switchToRegister()" class="text-blue-400 hover:text-blue-300">ç«‹å³æ³¨å†Œ</button>
                    </div>
                    
                    <button onclick="closeAuthModal()" class="w-full mt-4 px-6 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">
                        å–æ¶ˆ
                    </button>
                </div>
                
                <!-- æ³¨å†Œè¡¨å• -->
                <div id="register-form" style="display: none;">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold mb-2">æ³¨å†Œè´¦å·</h2>
                        <p class="text-gray-400 text-sm">åˆ›å»ºè´¦å·ï¼Œå¼€å¯åŠ å¯†è´§å¸ç¤¾åŒºä¹‹æ—…</p>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">ç”¨æˆ·å</label>
                            <input id="register-username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰" 
                                class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">é‚®ç®±</label>
                            <input id="register-email" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" 
                                class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">å¯†ç </label>
                            <input id="register-password" type="password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰" 
                                class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">ç¡®è®¤å¯†ç </label>
                            <input id="register-password-confirm" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " 
                                class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <button onclick="handleRegister()" class="w-full px-6 py-3 bg-green-600 rounded-lg hover:bg-green-700 font-semibold mb-3">
                        æ³¨å†Œ
                    </button>
                    
                    <div class="text-center text-sm text-gray-400">
                        å·²æœ‰è´¦å·ï¼Ÿ
                        <button onclick="switchToLogin()" class="text-blue-400 hover:text-blue-300">ç«‹å³ç™»å½•</button>
                    </div>
                    
                    <button onclick="closeAuthModal()" class="w-full mt-4 px-6 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¼šå‘˜å¼¹çª— -->
        <div id="membership-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50" style="display: none;">
            <div class="bg-gray-800 rounded-xl p-8 max-w-md mx-4 shadow-2xl border border-gray-700">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">ğŸ‘‘</div>
                    <h2 class="text-2xl font-bold mb-2">æˆä¸ºä¼šå‘˜</h2>
                    <p class="text-gray-400">è§£é”å…¨éƒ¨åŠŸèƒ½ï¼Œå¼€å¯é¢„æµ‹ä¹‹æ—…</p>
                </div>
                
                <div class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 rounded-lg p-6 mb-6 border border-yellow-500/30">
                    <div class="text-center mb-4">
                        <div class="text-4xl font-bold text-yellow-400 mb-2">1 USDT</div>
                        <div class="text-sm text-gray-400">ä¸€æ¬¡æ€§ä»˜è´¹ï¼Œæ°¸ä¹…ä¼šå‘˜</div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="text-green-400">âœ“</span>
                            <span>å‘èµ·é¢„æµ‹æŠ•ç¥¨</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-400">âœ“</span>
                            <span>å‚ä¸æ‰€æœ‰é¢„æµ‹</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-400">âœ“</span>
                            <span>é¢„æµ‹å‡†ç¡®è·å¾—å¥–åŠ±</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-400">âœ“</span>
                            <span>ä¸“å±ä¼šå‘˜æ ‡è¯†</span>
                        </div>
                    </div>
                </div>

                <button onclick="showPaymentQRCode()" class="w-full px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg hover:from-yellow-600 hover:to-orange-600 font-semibold text-white shadow-lg mb-3">
                    ç«‹å³æ”¯ä»˜ 1 USDT
                </button>
                <button onclick="closeMembershipModal()" class="w-full px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600">
                    ç¨åå†è¯´
                </button>
            </div>
        </div>

        <!-- æ”¯ä»˜äºŒç»´ç å¼¹çª— -->
        <div id="payment-qr-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50" style="display: none;">
            <div class="bg-gray-800 rounded-xl p-8 max-w-md mx-4 shadow-2xl border border-gray-700">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-4">ğŸ’³</div>
                    <h2 class="text-2xl font-bold mb-2">æ‰«ç æ”¯ä»˜</h2>
                    <p class="text-gray-400 text-sm">è¯·ä½¿ç”¨æ”¯æŒ BSC é“¾çš„é’±åŒ…æ‰«ç æ”¯ä»˜</p>
                </div>
                
                <!-- æ”¯ä»˜é‡‘é¢ -->
                <div class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 rounded-lg p-4 mb-6 border border-yellow-500/30 text-center">
                    <div class="text-3xl font-bold text-yellow-400 mb-1">1 USDT</div>
                    <div class="text-xs text-gray-400">BSC é“¾ï¼ˆBEP20ï¼‰</div>
                </div>
                
                <!-- äºŒç»´ç  -->
                <div class="bg-white p-4 rounded-lg mb-6 flex justify-center">
                    <div id="payment-qrcode"></div>
                </div>
                
                <!-- æ”¶æ¬¾åœ°å€ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-300">æ”¶æ¬¾åœ°å€</label>
                    <div class="flex items-center space-x-2">
                        <input id="payment-address" type="text" readonly 
                            value="0xAC061A7998ee4EDe184248e19F4C3Afc5Eab53B9"
                            class="flex-1 px-4 py-3 bg-gray-700 rounded-lg text-sm font-mono text-gray-300 focus:outline-none">
                        <button onclick="copyPaymentAddress()" 
                            class="px-4 py-3 bg-blue-600 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <span class="text-sm font-semibold">å¤åˆ¶</span>
                        </button>
                    </div>
                </div>
                
                <!-- æ”¯ä»˜è¯´æ˜ -->
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-6">
                    <div class="text-sm space-y-2 text-gray-300">
                        <div class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5">1.</span>
                            <span>ä½¿ç”¨æ”¯æŒ BSC é“¾çš„é’±åŒ…ï¼ˆå¦‚ Trust Walletã€MetaMaskï¼‰</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5">2.</span>
                            <span>æ‰«æäºŒç»´ç æˆ–å¤åˆ¶åœ°å€è¿›è¡Œè½¬è´¦</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5">3.</span>
                            <span>ç¡®ä¿é€‰æ‹© <strong class="text-yellow-400">BSC (BEP20)</strong> ç½‘ç»œ</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5">4.</span>
                            <span>æ”¯ä»˜å®Œæˆåï¼Œè¯·è”ç³»å®¢æœç¡®è®¤å‡çº§</span>
                        </div>
                    </div>
                </div>
                
                <!-- æ”¯ä»˜å®ŒæˆæŒ‰é’® -->
                <button onclick="confirmPayment()" class="w-full px-6 py-3 bg-green-600 rounded-lg hover:bg-green-700 font-semibold mb-3">
                    æˆ‘å·²å®Œæˆæ”¯ä»˜
                </button>
                
                <button onclick="closePaymentQRModal()" class="w-full px-6 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>

        <!-- é¢„æµ‹ç±»å‹é€‰æ‹©å¼¹çª— -->
        <div id="prediction-type-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50" style="display: none;">
            <div class="bg-gray-800 rounded-xl p-8 max-w-2xl mx-4 shadow-2xl border border-gray-700">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">é€‰æ‹©é¢„æµ‹ç±»å‹</h2>
                    <p class="text-gray-400 text-sm">è¯·é€‰æ‹©æ‚¨è¦å‘èµ·çš„é¢„æµ‹ç±»å‹</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- æ— å¥–é¢„æµ‹ -->
                    <div class="bg-gradient-to-br from-blue-900/30 to-cyan-900/30 border-2 border-blue-500/50 rounded-xl p-6 hover:border-blue-400 transition cursor-pointer" onclick="selectPredictionType('free')">
                        <div class="text-center mb-4">
                            <div class="text-5xl mb-3">ğŸ¯</div>
                            <h3 class="text-xl font-bold mb-2">æ— å¥–é¢„æµ‹</h3>
                            <div class="text-sm text-gray-400">å…è´¹å‘èµ·ï¼Œçº¯ç²¹é¢„æµ‹</div>
                        </div>
                        
                        <div class="space-y-2 text-sm mb-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-green-400">âœ“</span>
                                <span>å®Œå…¨å…è´¹</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-400">âœ“</span>
                                <span>æ— éœ€æ”¯ä»˜</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-400">âœ“</span>
                                <span>æ‰€æœ‰ç”¨æˆ·å¯å‚ä¸æŠ•ç¥¨</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-400">âœ“</span>
                                <span>æ— å¥–é‡‘æ± </span>
                            </div>
                        </div>
                        
                        <div class="bg-blue-900/30 rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-400 mb-1">æ¯æ—¥é™åˆ¶</div>
                            <div class="font-semibold text-sm">
                                æ™®é€šç”¨æˆ·ï¼š3æ¬¡/å¤©<br>
                                ä¼šå‘˜ç”¨æˆ·ï¼š10æ¬¡/å¤©
                            </div>
                        </div>
                    </div>
                    
                    <!-- æœ‰å¥–é¢„æµ‹ -->
                    <div class="bg-gradient-to-br from-yellow-900/30 to-orange-900/30 border-2 border-yellow-500/50 rounded-xl p-6 hover:border-yellow-400 transition cursor-pointer" onclick="selectPredictionType('reward')">
                        <div class="text-center mb-4">
                            <div class="text-5xl mb-3">ğŸ’°</div>
                            <h3 class="text-xl font-bold mb-2">æœ‰å¥–é¢„æµ‹</h3>
                            <div class="text-sm text-gray-400">è®¾ç½®å¥–é‡‘æ± ï¼Œèµ¢å–å¥–åŠ±</div>
                        </div>
                        
                        <div class="space-y-2 text-sm mb-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-400">â˜…</span>
                                <span>è®¾ç½®å¥–é‡‘æ± </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-400">â˜…</span>
                                <span>é¢„æµ‹å‡†ç¡®è·å¾—å¥–åŠ±</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-400">â˜…</span>
                                <span>æ‰€æœ‰ç”¨æˆ·å¯å‚ä¸æŠ•ç¥¨</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-400">â˜…</span>
                                <span>éœ€è¦ä¼šå‘˜æƒé™</span>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-900/30 rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-400 mb-1">æ¯æ—¥é™åˆ¶</div>
                            <div class="font-semibold text-yellow-400 text-sm">
                                ä¼šå‘˜ä¸“äº«ï¼š3æ¬¡/å¤©
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="closePredictionTypeModal()" class="w-full px-6 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </main>

    <script>
        // APIé…ç½®
        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        const CRYPTOCOMPARE_API = 'https://min-api.cryptocompare.com/data/v2';
        const queryApiBase = new URLSearchParams(location.search).get('api_base');
        const storedApiBase = localStorage.getItem('api_base');
        const defaultApiBase = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
            ? 'http://localhost:3000'
            : 'https://crypto-platform-api.vercel.app';
        const API_URL = queryApiBase || storedApiBase || defaultApiBase;
        const USDT_ADDRESS = '0x55d398326f99059fF775485246999027B3197955'; // BSC USDT
        const PLATFORM_ADDRESS = '0xAC061A7998ee4EDe184248e19F4C3Afc5Eab53B9'; // å¹³å°åœ°å€
        
        const USDT_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function balanceOf(address account) view returns (uint256)'
        ];
        
        // ç”¨æˆ·çŠ¶æ€
        let currentUser = null;
        let userToken = null;
        
        // æ•°æ®å­˜å‚¨
        let cryptoData = [];

        let economicData = [];
        let currentCalendarDate = new Date();
        let calendarFilter = 'all';
        let calendarAdvancedFilters = { importanceMin: 1, country: 'å…¨éƒ¨', type: 'å…¨éƒ¨' };
        
        // å›½å®¶ä»£ç æ˜ å°„
        const countryFlags = {
            'US': 'ğŸ‡ºğŸ‡¸', 'CN': 'ğŸ‡¨ğŸ‡³', 'JP': 'ğŸ‡¯ğŸ‡µ', 'GB': 'ğŸ‡¬ğŸ‡§', 'EU': 'ğŸ‡ªğŸ‡º', 
            'CA': 'ğŸ‡¨ğŸ‡¦', 'AU': 'ğŸ‡¦ğŸ‡º', 'DE': 'ğŸ‡©ğŸ‡ª', 'FR': 'ğŸ‡«ğŸ‡·', 'IT': 'ğŸ‡®ğŸ‡¹',
            'ES': 'ğŸ‡ªğŸ‡¸', 'CH': 'ğŸ‡¨ğŸ‡­', 'NZ': 'ğŸ‡³ğŸ‡¿', 'KR': 'ğŸ‡°ğŸ‡·', 'IN': 'ğŸ‡®ğŸ‡³'
        };
        
        const countryNames = {
            'US': 'ç¾å›½', 'CN': 'ä¸­å›½', 'JP': 'æ—¥æœ¬', 'GB': 'è‹±å›½', 'EU': 'æ¬§å…ƒåŒº',
            'CA': 'åŠ æ‹¿å¤§', 'AU': 'æ¾³å¤§åˆ©äºš', 'DE': 'å¾·å›½', 'FR': 'æ³•å›½', 'IT': 'æ„å¤§åˆ©',
            'ES': 'è¥¿ç­ç‰™', 'CH': 'ç‘å£«', 'NZ': 'æ–°è¥¿å…°', 'KR': 'éŸ©å›½', 'IN': 'å°åº¦'
        };
        
        // ç»æµäº‹ä»¶ä¸­è‹±æ–‡ç¿»è¯‘è¯å…¸
        const eventTranslations = {
            // é€šç”¨æœ¯è¯­
            'Meeting': 'ä¼šè®®', 'Rate': 'åˆ©ç‡', 'Decision': 'å†³è®®', 'Statement': 'å£°æ˜',
            'Minutes': 'ä¼šè®®çºªè¦', 'Speech': 'è®²è¯', 'Press Conference': 'æ–°é—»å‘å¸ƒä¼š',
            'Report': 'æŠ¥å‘Š', 'Index': 'æŒ‡æ•°', 'Survey': 'è°ƒæŸ¥', 'Forecast': 'é¢„æµ‹',
            'Preliminary': 'åˆå€¼', 'Final': 'ç»ˆå€¼', 'Revised': 'ä¿®æ­£å€¼',
            'Year': 'å¹´', 'Month': 'æœˆ', 'Quarter': 'å­£', 'Week': 'å‘¨',
            'Annual': 'å¹´ç‡', 'Monthly': 'æœˆç‡', 'Quarterly': 'å­£ç‡', 'Weekly': 'å‘¨ç‡',
            
            // å¤®è¡Œå’Œè´§å¸æ”¿ç­–
            'Central Bank': 'å¤®è¡Œ', 'Federal Reserve': 'ç¾è”å‚¨', 'Fed': 'ç¾è”å‚¨',
            'ECB': 'æ¬§æ´²å¤®è¡Œ', 'European Central Bank': 'æ¬§æ´²å¤®è¡Œ',
            'Bank of Japan': 'æ—¥æœ¬å¤®è¡Œ', 'BOJ': 'æ—¥æœ¬å¤®è¡Œ',
            'Bank of England': 'è‹±æ ¼å…°é“¶è¡Œ', 'BOE': 'è‹±æ ¼å…°é“¶è¡Œ',
            'People\'s Bank of China': 'ä¸­å›½äººæ°‘é“¶è¡Œ', 'PBOC': 'ä¸­å›½äººæ°‘é“¶è¡Œ',
            'Interest Rate': 'åˆ©ç‡', 'Policy Rate': 'æ”¿ç­–åˆ©ç‡',
            'Federal Funds Rate': 'è”é‚¦åŸºé‡‘åˆ©ç‡', 'Discount Rate': 'è´´ç°ç‡',
            'Reserve Requirement': 'å­˜æ¬¾å‡†å¤‡é‡‘ç‡',
            'Monetary Policy': 'è´§å¸æ”¿ç­–', 'Quantitative Easing': 'é‡åŒ–å®½æ¾',
            'Tapering': 'ç¼©å‡è´­å€º', 'Rate Hike': 'åŠ æ¯', 'Rate Cut': 'é™æ¯',
            'Governor': 'è¡Œé•¿', 'Chairman': 'ä¸»å¸­', 'President': 'æ€»è£',
            'Finance Minister': 'è´¢æ”¿éƒ¨é•¿', 'Treasury Secretary': 'è´¢æ”¿éƒ¨é•¿',
            
            // å°±ä¸šæ•°æ®
            'Non-Farm Payrolls': 'éå†œå°±ä¸šäººæ•°', 'NFP': 'éå†œå°±ä¸š',
            'Nonfarm Payrolls': 'éå†œå°±ä¸šäººæ•°',
            'Employment': 'å°±ä¸š', 'Unemployment': 'å¤±ä¸š', 'Jobless': 'å¤±ä¸š',
            'Unemployment Rate': 'å¤±ä¸šç‡', 'Employment Change': 'å°±ä¸šäººæ•°å˜åŒ–',
            'Job Openings': 'èŒä½ç©ºç¼º', 'JOLTS': 'èŒä½ç©ºç¼º',
            'Initial Jobless Claims': 'åˆè¯·å¤±ä¸šé‡‘äººæ•°',
            'Continuing Jobless Claims': 'ç»­è¯·å¤±ä¸šé‡‘äººæ•°',
            'ADP Employment': 'ADPå°±ä¸šäººæ•°', 'ADP': 'ADP',
            'Labor Force': 'åŠ³åŠ¨åŠ›', 'Participation Rate': 'åŠ³åŠ¨å‚ä¸ç‡',
            'Average Hourly Earnings': 'å¹³å‡æ—¶è–ª', 'Wage': 'å·¥èµ„',
            
            // é€šèƒ€æ•°æ®
            'CPI': 'æ¶ˆè´¹è€…ç‰©ä»·æŒ‡æ•°', 'Consumer Price Index': 'æ¶ˆè´¹è€…ç‰©ä»·æŒ‡æ•°',
            'Core CPI': 'æ ¸å¿ƒCPI', 'PPI': 'ç”Ÿäº§è€…ç‰©ä»·æŒ‡æ•°',
            'Producer Price Index': 'ç”Ÿäº§è€…ç‰©ä»·æŒ‡æ•°', 'Core PPI': 'æ ¸å¿ƒPPI',
            'Inflation': 'é€šèƒ€', 'Deflation': 'é€šç¼©',
            'PCE': 'ä¸ªäººæ¶ˆè´¹æ”¯å‡º', 'Personal Consumption Expenditures': 'ä¸ªäººæ¶ˆè´¹æ”¯å‡º',
            'Core PCE': 'æ ¸å¿ƒPCE', 'Import Price': 'è¿›å£ç‰©ä»·', 'Export Price': 'å‡ºå£ç‰©ä»·',
            
            // GDPå’Œç»æµå¢é•¿
            'GDP': 'GDP', 'Gross Domestic Product': 'å›½å†…ç”Ÿäº§æ€»å€¼',
            'GDP Growth': 'GDPå¢é•¿ç‡', 'Economic Growth': 'ç»æµå¢é•¿',
            'GDP Deflator': 'GDPå¹³å‡æŒ‡æ•°', 'Real GDP': 'å®é™…GDP',
            'Nominal GDP': 'åä¹‰GDP', 'GNP': 'å›½æ°‘ç”Ÿäº§æ€»å€¼',
            
            // é›¶å”®å’Œæ¶ˆè´¹
            'Retail Sales': 'é›¶å”®é”€å”®', 'Core Retail Sales': 'æ ¸å¿ƒé›¶å”®é”€å”®',
            'Consumer Spending': 'æ¶ˆè´¹è€…æ”¯å‡º', 'Personal Spending': 'ä¸ªäººæ”¯å‡º',
            'Consumer Confidence': 'æ¶ˆè´¹è€…ä¿¡å¿ƒæŒ‡æ•°', 'Consumer Sentiment': 'æ¶ˆè´¹è€…ä¿¡å¿ƒ',
            'Michigan Consumer Sentiment': 'å¯†æ­‡æ ¹æ¶ˆè´¹è€…ä¿¡å¿ƒæŒ‡æ•°',
            'Conference Board': 'è°˜å•†ä¼š', 'CB Consumer Confidence': 'è°˜å•†ä¼šæ¶ˆè´¹è€…ä¿¡å¿ƒæŒ‡æ•°',
            
            // åˆ¶é€ ä¸šå’Œå·¥ä¸š
            'PMI': 'é‡‡è´­ç»ç†äººæŒ‡æ•°', 'Manufacturing PMI': 'åˆ¶é€ ä¸šPMI',
            'Services PMI': 'æœåŠ¡ä¸šPMI', 'Composite PMI': 'ç»¼åˆPMI',
            'ISM Manufacturing': 'ISMåˆ¶é€ ä¸šæŒ‡æ•°', 'ISM Services': 'ISMæœåŠ¡ä¸šæŒ‡æ•°',
            'ISM': 'ISM', 'Industrial Production': 'å·¥ä¸šç”Ÿäº§',
            'Factory Orders': 'å·¥å‚è®¢å•', 'Durable Goods': 'è€ç”¨å“è®¢å•',
            'Core Durable Goods': 'æ ¸å¿ƒè€ç”¨å“è®¢å•',
            'Capacity Utilization': 'äº§èƒ½åˆ©ç”¨ç‡', 'Manufacturing': 'åˆ¶é€ ä¸š',
            
            // æˆ¿åœ°äº§
            'Housing Starts': 'æ–°å±‹å¼€å·¥', 'Building Permits': 'è¥å»ºè®¸å¯',
            'Existing Home Sales': 'æˆå±‹é”€å”®', 'New Home Sales': 'æ–°å±‹é”€å”®',
            'Pending Home Sales': 'å¾…å®Œæˆæˆ¿å±‹é”€å”®',
            'Home Price': 'æˆ¿ä»·', 'Case-Shiller': 'å‡¯æ–¯-å¸­å‹’æˆ¿ä»·æŒ‡æ•°',
            'FHFA House Price': 'FHFAæˆ¿ä»·æŒ‡æ•°',
            
            // è´¸æ˜“å’Œå›½é™…æ”¶æ”¯
            'Trade Balance': 'è´¸æ˜“å¸', 'Current Account': 'ç»å¸¸å¸',
            'Exports': 'å‡ºå£', 'Imports': 'è¿›å£', 'Trade Deficit': 'è´¸æ˜“é€†å·®',
            'Trade Surplus': 'è´¸æ˜“é¡ºå·®', 'Balance of Payments': 'å›½é™…æ”¶æ”¯',
            
            // å•†ä¸šå’Œä¼ä¸š
            'Business Confidence': 'ä¼ä¸šä¿¡å¿ƒ', 'Business Sentiment': 'ä¼ä¸šæ™¯æ°”',
            'Business Investment': 'ä¼ä¸šæŠ•èµ„', 'Capital Expenditure': 'èµ„æœ¬æ”¯å‡º',
            'Corporate Profits': 'ä¼ä¸šåˆ©æ¶¦', 'Earnings': 'æ”¶ç›Š',
            'IFO Business Climate': 'IFOå•†ä¸šæ™¯æ°”æŒ‡æ•°',
            'ZEW Economic Sentiment': 'ZEWç»æµæ™¯æ°”æŒ‡æ•°',
            'Tankan': 'çŸ­è§‚è°ƒæŸ¥', 'Beige Book': 'è¤çš®ä¹¦',
            
            // å›½å€ºå’Œæ‹å–
            'Treasury': 'å›½å€º', 'Bond': 'å€ºåˆ¸', 'Auction': 'ç«æ‹',
            'Bill': 'çŸ­æœŸå›½å€º', 'Note': 'ä¸­æœŸå›½å€º',
            'Yield': 'æ”¶ç›Šç‡', 'Bid-to-Cover': 'æŠ•æ ‡å€æ•°',
            '4-Week': '4å‘¨', '3-Month': '3ä¸ªæœˆ', '6-Month': '6ä¸ªæœˆ',
            '1-Year': '1å¹´', '2-Year': '2å¹´', '5-Year': '5å¹´',
            '10-Year': '10å¹´', '20-Year': '20å¹´', '30-Year': '30å¹´',
            
            // å…¶ä»–é‡è¦æŒ‡æ ‡
            'Leading Indicators': 'é¢†å…ˆæŒ‡æ ‡', 'Coincident Index': 'åŒæ­¥æŒ‡æ ‡',
            'Lagging Indicators': 'æ»åæŒ‡æ ‡',
            'Loan Prime Rate': 'è´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡', 'LPR': 'è´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡',
            'Swift': 'Swift', 'Foreign Exchange': 'å¤–æ±‡', 'FX': 'å¤–æ±‡',
            'Reserves': 'å‚¨å¤‡', 'Foreign Reserves': 'å¤–æ±‡å‚¨å¤‡',
            'M2 Money Supply': 'M2è´§å¸ä¾›åº”', 'M1': 'M1', 'M2': 'M2', 'M3': 'M3',
            'Credit': 'ä¿¡è´·', 'Loan': 'è´·æ¬¾', 'Lending': 'è´·æ¬¾',
            'Fiscal': 'è´¢æ”¿', 'Budget': 'é¢„ç®—', 'Deficit': 'èµ¤å­—', 'Surplus': 'ç›ˆä½™',
            'Debt': 'å€ºåŠ¡', 'Government Debt': 'æ”¿åºœå€ºåŠ¡',
            
            // ç‰¹å®šäº‹ä»¶
            'G7': 'G7', 'G20': 'G20', 'OPEC': 'æ¬§ä½©å…‹',
            'Payrolls': 'å°±ä¸šäººæ•°', 'Claims': 'ç”³è¯·äººæ•°',
            'Sales': 'é”€å”®', 'Orders': 'è®¢å•', 'Inventories': 'åº“å­˜',
            'Production': 'ç”Ÿäº§', 'Output': 'äº§å‡º',
            'Prices': 'ç‰©ä»·', 'Costs': 'æˆæœ¬',
            'Sentiment': 'ä¿¡å¿ƒ', 'Confidence': 'ä¿¡å¿ƒ',
            'Activity': 'æ´»åŠ¨', 'Growth': 'å¢é•¿', 'Change': 'å˜åŒ–',
            'Data': 'æ•°æ®', 'Figure': 'æ•°æ®', 'Number': 'æ•°æ®',
            'Estimate': 'é¢„ä¼°', 'Expectation': 'é¢„æœŸ',
            'Target': 'ç›®æ ‡', 'Projection': 'é¢„æµ‹',
            
            // æœˆä»½
            'January': '1æœˆ', 'February': '2æœˆ', 'March': '3æœˆ',
            'April': '4æœˆ', 'May': '5æœˆ', 'June': '6æœˆ',
            'July': '7æœˆ', 'August': '8æœˆ', 'September': '9æœˆ',
            'October': '10æœˆ', 'November': '11æœˆ', 'December': '12æœˆ',
            'Jan': '1æœˆ', 'Feb': '2æœˆ', 'Mar': '3æœˆ', 'Apr': '4æœˆ',
            'Jun': '6æœˆ', 'Jul': '7æœˆ', 'Aug': '8æœˆ', 'Sep': '9æœˆ',
            'Oct': '10æœˆ', 'Nov': '11æœˆ', 'Dec': '12æœˆ',
            
            // å…¶ä»–å¸¸ç”¨è¯
            'and': 'å’Œ', 'of': '', 'the': '', 'for': '',
            'in': '', 'on': '', 'at': '', 'to': '',
            'from': 'æ¥è‡ª', 'with': 'ä¸', 'by': 'ç”±',
            'Total': 'æ€»', 'Net': 'å‡€', 'Gross': 'æ€»',
            'Private': 'ç§äºº', 'Public': 'å…¬å…±', 'Government': 'æ”¿åºœ',
            'National': 'å…¨å›½', 'Regional': 'åœ°åŒº', 'Local': 'åœ°æ–¹',
            'Domestic': 'å›½å†…', 'Foreign': 'å¤–å›½', 'International': 'å›½é™…',
            'Global': 'å…¨çƒ', 'Worldwide': 'å…¨çƒ',
        };
        
        // ç¿»è¯‘ç»æµäº‹ä»¶åç§°
        function translateEconomicEvent(eventName) {
            if (!eventName) return eventName;
            
            let translated = eventName;
            
            // æŒ‰è¯é•¿åº¦æ’åºï¼Œä¼˜å…ˆåŒ¹é…é•¿è¯ç»„
            const sortedKeys = Object.keys(eventTranslations).sort((a, b) => b.length - a.length);
            
            for (const key of sortedKeys) {
                const value = eventTranslations[key];
                if (value) {  // åªæ›¿æ¢æœ‰ç¿»è¯‘çš„è¯
                    const regex = new RegExp(key, 'gi');
                    translated = translated.replace(regex, value);
                }
            }
            
            // æ¸…ç†å¤šä½™ç©ºæ ¼
            translated = translated.replace(/\s+/g, ' ').trim();
            
            // å¦‚æœç¿»è¯‘åè¿˜æœ‰å¾ˆå¤šè‹±æ–‡ï¼Œä¿ç•™åŸæ–‡
            const chineseChars = (translated.match(/[\u4e00-\u9fa5]/g) || []).length;
            const totalChars = translated.replace(/\s/g, '').length;
            
            // å¦‚æœä¸­æ–‡å­—ç¬¦å°‘äº30%ï¼Œè¿”å›åŸæ–‡
            if (totalChars > 0 && chineseChars / totalChars < 0.3) {
                return eventName;
            }
            
            return translated;
        }
        
        // åŠ è½½çœŸå®ç»æµæ•°æ®
        async function loadEconomicData() {
            try {
                const base = new Date(currentCalendarDate || new Date());
                const day = base.getDay();
                const mondayOffset = (day + 6) % 7;
                const monday = new Date(base);
                monday.setDate(base.getDate() - mondayOffset);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                const startStr = `${monday.getFullYear()}-${String(monday.getMonth()+1).padStart(2,'0')}-${String(monday.getDate()).padStart(2,'0')}`;
                const endStr = `${sunday.getFullYear()}-${String(sunday.getMonth()+1).padStart(2,'0')}-${String(sunday.getDate()).padStart(2,'0')}`;
                const res = await fetch(`${API_URL}/api/calendar?start=${startStr}&end=${endStr}`);
                if (!res.ok) throw new Error('calendar api failed');
                const json = await res.json();
                const list = Array.isArray(json.data) ? json.data : [];
                economicData = list.map((item, index) => {
                    const dt = new Date(`${item.date}T${(item.time || '00:00')}:00`);
                    return {
                        id: item.id || index + 1,
                        country: item.country || 'ğŸŒ',
                        countryName: item.countryName || 'æœªçŸ¥',
                        event: translateEconomicEvent(item.event || 'æœªçŸ¥äº‹ä»¶'),
                        dateObj: dt,
                        time: item.time || dt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                        importance: item.importance || 1,
                        status: item.status === 'published' ? 'published' : 'upcoming',
                        previous: item.previous || '--',
                        forecast: item.forecast || '--',
                        actual: item.actual || '',
                        impact: item.impact || determineImpact(item.actual, item.forecast, item.previous)
                    };
                });
                renderEconomicCalendar();
            } catch (error) {
                console.error('Failed to load from Trading Economics:', error);
                try {
                    await loadFromForexFactory();
                } catch (error2) {
                    console.error('Failed to load from Forex Factory:', error2);
                    // ä½¿ç”¨åå¤‡æ¨¡æ‹Ÿæ•°æ®
                    loadMockEconomicData();
                }
            }
        }
        
        // ä» Trading Economics API åŠ è½½ï¼ˆå…è´¹ä»£ç†ï¼‰
        async function loadFromTradingEconomics() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 1);
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 7);
            
            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];
            
            // ä½¿ç”¨å…¬å¼€çš„ç»æµæ—¥å† API
            const response = await fetch(
                `https://api.tradingeconomics.com/calendar?c=guest:guest&d1=${startStr}&d2=${endStr}`,
                { timeout: 5000 }
            );
            
            if (!response.ok) throw new Error('API request failed');
            
            const data = await response.json();
            economicData = data.map((item, index) => ({
                id: index + 1,
                country: countryFlags[item.Country] || 'ğŸŒ',
                countryName: countryNames[item.Country] || item.Country,
                event: translateEconomicEvent(item.Event),
                dateObj: new Date(item.Date),
                time: new Date(item.Date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                importance: item.Importance === 'High' ? 5 : item.Importance === 'Medium' ? 3 : 1,
                status: item.Actual ? 'published' : 'upcoming',
                previous: item.Previous ? String(item.Previous) : '--',
                forecast: item.Forecast ? String(item.Forecast) : '--',
                actual: item.Actual ? String(item.Actual) : '',
                impact: determineImpact(item.Actual, item.Forecast, item.Previous)
            }));
            
            renderEconomicCalendar();
        }
        
        // ä» Forex Factory é£æ ¼çš„ API åŠ è½½
        async function loadFromForexFactory() {
            // ä½¿ç”¨å…¬å¼€çš„é‡‘èæ—¥å† API
            const response = await fetch('https://nfs.faireconomy.media/ff_calendar_thisweek.json', {
                timeout: 5000
            });
            
            if (!response.ok) throw new Error('API request failed');
            
            const data = await response.json();
            economicData = data.map((item, index) => {
                const eventDate = new Date(item.date);
                return {
                    id: index + 1,
                    country: countryFlags[item.country] || 'ğŸŒ',
                    countryName: countryNames[item.country] || item.country,
                    event: translateEconomicEvent(item.title),
                    dateObj: eventDate,
                    time: item.time || '00:00',
                    importance: item.impact === 'High' ? 5 : item.impact === 'Medium' ? 3 : 1,
                    status: item.actual ? 'published' : 'upcoming',
                    previous: item.previous || '--',
                    forecast: item.forecast || '--',
                    actual: item.actual || '',
                    impact: determineImpact(item.actual, item.forecast, item.previous)
                };
            });
            
            renderEconomicCalendar();
        }
        
        // åˆ¤æ–­å½±å“
        function determineImpact(actual, forecast, previous) {
            if (!actual || !forecast) return 'neutral';
            
            const actualNum = parseFloat(String(actual).replace(/[^0-9.-]/g, ''));
            const forecastNum = parseFloat(String(forecast).replace(/[^0-9.-]/g, ''));
            
            if (isNaN(actualNum) || isNaN(forecastNum)) return 'neutral';
            
            if (actualNum > forecastNum) return 'bullish';
            if (actualNum < forecastNum) return 'bearish';
            return 'neutral';
        }
        
        // åå¤‡æ¨¡æ‹Ÿæ•°æ®
        function loadMockEconomicData() {
            const today = new Date();
            const addDays = (date, days) => {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            };
            
            economicData = [
                // ä»Šå¤©
                { id: 1, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: '4ä¸ªæœˆå›½å€ºç«æ‹-å¾—æ ‡åˆ©ç‡', dateObj: today, time: '00:30', importance: 1, status: 'published', previous: '3.75%', forecast: '--', actual: '3.75%', impact: 'neutral' },
                { id: 2, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: '4ä¸ªæœˆå›½å€ºç«æ‹-å¾—æ ‡åˆ©ç‡é…ç½®ç™¾åˆ†æ¯”', dateObj: today, time: '00:30', importance: 1, status: 'published', previous: '95.87%', forecast: '--', actual: '32.08%', impact: 'bullish' },
                { id: 3, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: '4ä¸ªæœˆå›½å€ºç«æ‹-æŠ•æ ‡å€æ•°', dateObj: today, time: '00:30', importance: 1, status: 'published', previous: '3.18', forecast: '--', actual: '3.15', impact: 'bullish' },
                { id: 4, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: '20å¹´æœŸå›½å€ºç«æ‹-å¾—æ ‡åˆ©ç‡', dateObj: today, time: '02:00', importance: 2, status: 'published', previous: '4.51%', forecast: '--', actual: '4.706%', impact: 'bullish' },
                { id: 5, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: '20å¹´æœŸå›½å€ºç«æ‹-å¾—æ ‡åˆ©ç‡é…ç½®ç™¾åˆ†æ¯”', dateObj: today, time: '02:00', importance: 2, status: 'published', previous: '56.07%', forecast: '--', actual: '62.39%', impact: 'bearish' },
                { id: 6, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: '20å¹´æœŸå›½å€ºç«æ‹-æŠ•æ ‡å€æ•°', dateObj: today, time: '02:00', importance: 2, status: 'published', previous: '2.73', forecast: '--', actual: '2.61', impact: 'bullish' },
                { id: 7, country: 'ğŸ‡¯ğŸ‡µ', countryName: 'æ—¥æœ¬', event: 'å½“å‘¨ä¹°è¿›å¤–å›½å€ºåˆ¸', dateObj: today, time: '07:50', importance: 2, status: 'published', previous: '5663', forecast: '--', actual: '3484', impact: 'bullish' },
                { id: 8, country: 'ğŸ‡¯ğŸ‡µ', countryName: 'æ—¥æœ¬', event: 'å½“å‘¨ä¹°è¿›å¤–å›½è‚¡ç¥¨', dateObj: today, time: '07:50', importance: 2, status: 'published', previous: '-4395', forecast: '--', actual: '1833', impact: 'bearish' },
                { id: 9, country: 'ğŸ‡¯ğŸ‡µ', countryName: 'æ—¥æœ¬', event: 'å½“å‘¨å¤–èµ„ä¹°è¿›æ—¥å€º', dateObj: today, time: '07:50', importance: 1, status: 'published', previous: '915', forecast: '--', actual: '9616', impact: 'bearish' },
                { id: 10, country: 'ğŸ‡¯ğŸ‡µ', countryName: 'æ—¥æœ¬', event: 'å½“å‘¨å¤–èµ„ä¹°è¿›æ—¥è‚¡', dateObj: today, time: '07:50', importance: 1, status: 'published', previous: '-3473', forecast: '--', actual: '10209', impact: 'bearish' },
                { id: 11, country: 'ğŸ‡¨ğŸ‡³', countryName: 'ä¸­å›½', event: 'Swiftäººæ°‘å¸åœ¨å…¨çƒæ”¯ä»˜ä¸­å æ¯”', dateObj: today, time: '09:00', importance: 3, status: 'published', previous: '3.17%', forecast: '--', actual: '2.47%', impact: 'bullish' },
                { id: 12, country: 'ğŸ‡¨ğŸ‡³', countryName: 'ä¸­å›½', event: 'ä¸€å¹´æœŸè´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡', dateObj: today, time: '09:00', importance: 3, status: 'upcoming', previous: '3.00%', forecast: '3.00%', actual: '', impact: 'neutral' },
                { id: 13, country: 'ğŸ‡¨ğŸ‡³', countryName: 'ä¸­å›½', event: 'äº”å¹´æœŸè´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡', dateObj: today, time: '09:00', importance: 2, status: 'upcoming', previous: '3.50%', forecast: '3.50%', actual: '', impact: 'neutral' },
                
                // æ˜å¤©
                { id: 14, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: 'éå†œå°±ä¸šæ•°æ®', dateObj: addDays(today, 1), time: '21:30', importance: 5, status: 'upcoming', previous: '15ä¸‡', forecast: '18ä¸‡', actual: '', impact: 'high' },
                { id: 15, country: 'ğŸ‡¨ğŸ‡¦', countryName: 'åŠ æ‹¿å¤§', event: 'å°±ä¸šæ•°æ®', dateObj: addDays(today, 1), time: '21:30', importance: 3, status: 'upcoming', previous: '1.8ä¸‡', forecast: '2.0ä¸‡', actual: '', impact: 'medium' },
                { id: 16, country: 'ğŸ‡¬ğŸ‡§', countryName: 'è‹±å›½', event: 'GDPå­£ç‡åˆå€¼', dateObj: addDays(today, 1), time: '15:00', importance: 4, status: 'upcoming', previous: '0.2%', forecast: '0.3%', actual: '', impact: 'high' },
                
                // åå¤©
                { id: 17, country: 'ğŸ‡¨ğŸ‡³', countryName: 'ä¸­å›½', event: 'CPIå¹´ç‡', dateObj: addDays(today, 2), time: '09:30', importance: 4, status: 'upcoming', previous: '0.2%', forecast: '0.3%', actual: '', impact: 'high' },
                { id: 18, country: 'ğŸ‡ªğŸ‡º', countryName: 'æ¬§å…ƒåŒº', event: 'åˆ¶é€ ä¸šPMIåˆå€¼', dateObj: addDays(today, 2), time: '17:00', importance: 3, status: 'upcoming', previous: '46.5', forecast: '47.0', actual: '', impact: 'medium' },
                { id: 19, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: 'é›¶å”®é”€å”®æœˆç‡', dateObj: addDays(today, 3), time: '21:30', importance: 4, status: 'upcoming', previous: '0.4%', forecast: '0.5%', actual: '', impact: 'high' },
                
                // æœªæ¥ä¸€å‘¨
                { id: 20, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: 'CPIå¹´ç‡', dateObj: addDays(today, 5), time: '21:30', importance: 5, status: 'upcoming', previous: '3.2%', forecast: '3.1%', actual: '', impact: 'high' },
                { id: 21, country: 'ğŸ‡¬ğŸ‡§', countryName: 'è‹±å›½', event: 'å¤±ä¸šç‡', dateObj: addDays(today, 6), time: '15:00', importance: 3, status: 'upcoming', previous: '4.2%', forecast: '4.3%', actual: '', impact: 'medium' },
                { id: 22, country: 'ğŸ‡ºğŸ‡¸', countryName: 'ç¾å›½', event: 'è”é‚¦åŸºé‡‘åˆ©ç‡å†³è®®', dateObj: addDays(today, 7), time: '03:00', importance: 5, status: 'upcoming', previous: '5.50%', forecast: '5.50%', actual: '', impact: 'high' },
                { id: 23, country: 'ğŸ‡¯ğŸ‡µ', countryName: 'æ—¥æœ¬', event: 'æ ¸å¿ƒCPIå¹´ç‡', dateObj: addDays(today, 8), time: '07:30', importance: 4, status: 'upcoming', previous: '2.8%', forecast: '2.7%', actual: '', impact: 'high' },
                { id: 24, country: 'ğŸ‡¦ğŸ‡º', countryName: 'æ¾³å¤§åˆ©äºš', event: 'å°±ä¸šäººæ•°å˜åŒ–', dateObj: addDays(today, 9), time: '08:30', importance: 3, status: 'upcoming', previous: '6.4ä¸‡', forecast: '2.5ä¸‡', actual: '', impact: 'medium' },
                { id: 25, country: 'ğŸ‡ªğŸ‡º', countryName: 'æ¬§å…ƒåŒº', event: 'ECBåˆ©ç‡å†³è®®', dateObj: addDays(today, 10), time: '20:15', importance: 5, status: 'upcoming', previous: '4.50%', forecast: '4.50%', actual: '', impact: 'high' },
                { id: 26, country: 'ğŸ‡¨ğŸ‡³', countryName: 'ä¸­å›½', event: 'å·¥ä¸šå¢åŠ å€¼å¹´ç‡', dateObj: addDays(today, 11), time: '10:00', importance: 3, status: 'upcoming', previous: '4.5%', forecast: '4.7%', actual: '', impact: 'medium' },
                { id: 27, country: 'ğŸ‡¯ğŸ‡µ', countryName: 'æ—¥æœ¬', event: 'å¤®è¡Œåˆ©ç‡å†³è®®', dateObj: addDays(today, 12), time: '11:00', importance: 4, status: 'upcoming', previous: '-0.10%', forecast: '-0.10%', actual: '', impact: 'high' },
                { id: 28, country: 'ğŸ‡©ğŸ‡ª', countryName: 'å¾·å›½', event: 'IFOå•†ä¸šæ™¯æ°”æŒ‡æ•°', dateObj: addDays(today, 13), time: '17:00', importance: 3, status: 'upcoming', previous: '86.9', forecast: '87.5', actual: '', impact: 'medium' },
            ];
            
            renderEconomicCalendar();
            
            // æ˜¾ç¤ºæç¤º
            const calendarPage = document.getElementById('calendar-page');
            if (calendarPage && !document.getElementById('api-fallback-notice')) {
                const notice = document.createElement('div');
                notice.id = 'api-fallback-notice';
                notice.className = 'mt-6 p-4 bg-yellow-900/20 border border-yellow-500/30 rounded-lg';
                notice.innerHTML = '<p class="text-sm text-yellow-300">âš ï¸ <strong>æ¼”ç¤ºæ•°æ®ï¼š</strong>æ— æ³•è¿æ¥åˆ°çœŸå® APIï¼Œå½“å‰æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ã€‚éƒ¨ç½²åˆ°æœåŠ¡å™¨åå°†è‡ªåŠ¨ä½¿ç”¨çœŸå®æ•°æ®ã€‚</p>';
                calendarPage.appendChild(notice);
            }
        }
        
        // æ¸²æŸ“ç»æµæ—¥å†
        function renderEconomicCalendar() {
            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            const dateDisplay = document.getElementById('calendar-date-display');
            if (dateDisplay) {
                const d = currentCalendarDate;
                const pad = (n) => String(n).padStart(2, '0');
                dateDisplay.textContent = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
            }
            
            // æ¸²æŸ“å‘¨æ ‡ç­¾
            renderWeekTabs();
            updateCalendarFilterOptions();
            
            // ç­›é€‰æ•°æ®ï¼šé»˜è®¤æ˜¾ç¤ºå½“å‰é€‰ä¸­æ—¥æœŸçš„æ•°æ®ï¼›â€œé‡è¦â€åœ¨æ­¤åŸºç¡€ä¸Šç­›é€‰é‡è¦çº§åˆ«
            const d = currentCalendarDate;
            const currentDateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            let filteredData = economicData.filter(ev => {
                const dd = ev.dateObj;
                const ds = `${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,'0')}-${String(dd.getDate()).padStart(2,'0')}`;
                return ds === currentDateStr;
            });
            if (calendarFilter === 'important') {
                filteredData = filteredData.filter(d => d.importance >= 3);
            }
            filteredData = filteredData.filter(d => d.importance >= calendarAdvancedFilters.importanceMin);
            if (calendarAdvancedFilters.country && calendarAdvancedFilters.country !== 'å…¨éƒ¨') {
                filteredData = filteredData.filter(d => d.countryName === calendarAdvancedFilters.country);
            }
            if (calendarAdvancedFilters.type && calendarAdvancedFilters.type !== 'å…¨éƒ¨') {
                filteredData = filteredData.filter(d => classifyEventType(d.event) === calendarAdvancedFilters.type);
            }
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groupedByDate = {};
            filteredData.forEach(event => {
                const dateKey = event.dateObj.toISOString().split('T')[0];
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(event);
            });
            
            // æ¸²æŸ“äº‹ä»¶åˆ—è¡¨
            const eventsList = document.getElementById('calendar-events-list');
            if (eventsList) {
                let html = '';
                Object.keys(groupedByDate).sort().forEach(dateKey => {
                    const events = groupedByDate[dateKey].sort((a, b) => a.time.localeCompare(b.time));
                    events.forEach(event => {
                        const impactColor = event.impact === 'bullish' ? 'text-green-400' : 
                                          event.impact === 'bearish' ? 'text-red-400' : 'text-yellow-400';
                        const impactText = event.impact === 'bullish' ? 'åˆ©ç©º é‡‘é“¶' : 
                                         event.impact === 'bearish' ? 'åˆ©å¤š é‡‘é“¶' : 'å½±å“è¾ƒå°';
                        const statusBadge = event.status === 'published' ? 
                            '<span class="text-xs px-2 py-1 bg-green-900/50 text-green-400 rounded">å·²å…¬å¸ƒ</span>' : 
                            '<span class="text-xs px-2 py-1 bg-blue-900/50 text-blue-400 rounded">å¾…å…¬å¸ƒ</span>';
                        
                        html += `
                            <div class="grid grid-cols-12 gap-4 px-6 py-4 hover:bg-gray-750 transition cursor-pointer border-l-4 ${event.importance >= 3 ? 'border-yellow-500' : 'border-transparent'}">
                                <div class="col-span-1 text-sm text-gray-400">${event.time}</div>
                                <div class="col-span-1 text-sm">${event.country}</div>
                                <div class="col-span-3 text-sm" onclick="openCalendarDetail(${event.id})">
                                    <div class="font-semibold text-white">${event.event}</div>
                                    ${statusBadge}
                                </div>
                                <div class="col-span-1 text-center">
                                    <span class="text-yellow-400">${'â­'.repeat(event.importance)}</span>
                                </div>
                                <div class="col-span-1 text-right text-sm text-gray-300">${event.previous}</div>
                                <div class="col-span-1 text-right text-sm text-gray-300">${event.forecast}</div>
                                <div class="col-span-1 text-right text-sm font-semibold ${event.actual ? impactColor : 'text-gray-600'}">
                                    ${event.actual || '--'}
                                </div>
                                <div class="col-span-2 text-center">
                                    <span class="text-xs px-3 py-1 rounded ${event.impact === 'bullish' ? 'bg-green-900/30 text-green-400' : event.impact === 'bearish' ? 'bg-red-900/30 text-red-400' : 'bg-gray-700 text-gray-400'}">
                                        ${impactText}
                                    </span>
                                </div>
                                <div class="col-span-1 text-center">
                                    <button class="text-gray-400 hover:text-yellow-400 transition" onclick="toggleReminder('${currentDateStr}_${event.id}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                });
                eventsList.innerHTML = html || '<div class="px-6 py-8 text-center text-gray-400">æš‚æ— æ•°æ®</div>';
            }

            const summary = document.getElementById('calendar-day-summary');
            if (summary) {
                const total = filteredData.length;
                const published = filteredData.filter(e => e.status === 'published').length;
                const upcoming = total - published;
                const bull = filteredData.filter(e => e.impact === 'bullish').length;
                const bear = filteredData.filter(e => e.impact === 'bearish').length;
                const avgImp = total ? Math.round(filteredData.reduce((s,e)=>s+e.importance,0)/total) : 0;
                summary.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <span>äº‹ä»¶æ•°ï¼š<span class="text-white font-semibold">${total}</span></span>
                            <span>å·²å…¬å¸ƒï¼š<span class="text-green-400 font-semibold">${published}</span></span>
                            <span>å¾…å…¬å¸ƒï¼š<span class="text-blue-400 font-semibold">${upcoming}</span></span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span>å½±å“ï¼š<span class="text-red-400">åˆ©å¤š ${bear}</span> / <span class="text-green-400">åˆ©ç©º ${bull}</span> / <span class="text-gray-400">å° ${total - bull - bear}</span></span>
                            <span>å¹³å‡é‡è¦æ€§ï¼š<span class="text-yellow-400 font-semibold">${'â­'.repeat(Math.max(1, avgImp))}</span></span>
                        </div>
                    </div>`;
            }
        }

        function onCalendarImportanceChange(e) {
            const v = parseInt(e.target.value, 10);
            calendarAdvancedFilters.importanceMin = isNaN(v) ? 1 : v;
            renderEconomicCalendar();
        }
        function onCalendarCountryChange(e) {
            calendarAdvancedFilters.country = e.target.value || 'å…¨éƒ¨';
            renderEconomicCalendar();
        }
        function onCalendarTypeChange(e) {
            calendarAdvancedFilters.type = e.target.value || 'å…¨éƒ¨';
            renderEconomicCalendar();
        }
        function classifyEventType(name) {
            const n = String(name || '').toUpperCase();
            if (n.includes('CPI') || n.includes('CONSUMER PRICE')) return 'CPI';
            if (n.includes('PPI') || n.includes('PRODUCER PRICE')) return 'PPI';
            if (n.includes('GDP') || n.includes('GROSS DOMESTIC')) return 'GDP';
            if (n.includes('PMI')) return 'PMI';
            if (n.includes('UNEMP') || n.includes('JOB') || n.includes('EMPLOY') || n.includes('LABOR')) return 'å°±ä¸š';
            if (n.includes('RATE') || n.includes('INTEREST') || n.includes('FED') || n.includes('ECB') || n.includes('BOJ') || n.includes('BOE')) return 'åˆ©ç‡';
            if (n.includes('RETAIL') || n.includes('SALES')) return 'é›¶å”®';
            if (n.includes('TRADE') || n.includes('BALANCE') || n.includes('EXPORT') || n.includes('IMPORT')) return 'è´¸æ˜“';
            return 'å…¶ä»–';
        }
        function updateCalendarFilterOptions() {
            const countrySel = document.getElementById('calendar-country-select');
            if (!countrySel) return;
            const set = new Set(['å…¨éƒ¨']);
            economicData.forEach(d => { if (d.countryName) set.add(d.countryName); });
            countrySel.innerHTML = Array.from(set).map(c => `<option value="${c}">${c}</option>`).join('');
            countrySel.value = calendarAdvancedFilters.country;
        }

        let calendarReminders = JSON.parse(localStorage.getItem('calendarReminders') || '{}');
        function toggleReminder(key) {
            const v = !!calendarReminders[key];
            calendarReminders[key] = !v;
            localStorage.setItem('calendarReminders', JSON.stringify(calendarReminders));
        }
        function openCalendarDetail(id) {
            const ev = economicData.find(e => String(e.id) === String(id));
            if (!ev) return;
            const modal = document.getElementById('calendar-detail-modal');
            const box = document.getElementById('calendar-detail-box');
            const impactColor = ev.impact === 'bullish' ? 'text-green-400' : ev.impact === 'bearish' ? 'text-red-400' : 'text-yellow-400';
            const impactText = ev.impact === 'bullish' ? 'åˆ©ç©º é‡‘é“¶' : ev.impact === 'bearish' ? 'åˆ©å¤š é‡‘é“¶' : 'å½±å“è¾ƒå°';
            box.innerHTML = `
                <div class="text-lg font-semibold mb-2">${ev.event}</div>
                <div class="text-sm mb-4">${ev.country} Â· ${ev.time}</div>
                <div class="grid grid-cols-3 gap-2 mb-4 text-sm">
                    <div class="bg-gray-800 rounded p-3"><div class="text-gray-400">å‰å€¼</div><div class="text-white font-semibold">${ev.previous}</div></div>
                    <div class="bg-gray-800 rounded p-3"><div class="text-gray-400">é¢„æµ‹</div><div class="text-yellow-400 font-semibold">${ev.forecast}</div></div>
                    <div class="bg-gray-800 rounded p-3"><div class="text-gray-400">å…¬å¸ƒ</div><div class="font-semibold ${ev.actual ? impactColor : 'text-gray-600'}">${ev.actual || '--'}</div></div>
                </div>
                <div class="text-sm ${impactColor}">${impactText}</div>`;
            modal.style.display = 'flex';
        }
        function closeCalendarDetail() {
            const modal = document.getElementById('calendar-detail-modal');
            modal.style.display = 'none';
        }
        
        // æ¸²æŸ“å‘¨æ ‡ç­¾
        function renderWeekTabs() {
            const weekTabs = document.getElementById('calendar-week-tabs');
            if (!weekTabs) return;
            const base = new Date(currentCalendarDate || new Date());
            const day = base.getDay();
            const mondayOffset = (day + 6) % 7;
            const monday = new Date(base);
            monday.setDate(base.getDate() - mondayOffset);
            const pad = (n) => String(n).padStart(2,'0');
            const baseStr = `${base.getFullYear()}-${pad(base.getMonth()+1)}-${pad(base.getDate())}`;
            let html = '';
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                const ds = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
                const isSelected = ds === baseStr;
                const dayLabels = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
                html += `
                    <button onclick="setCalendarDate('${ds}')" class="flex-shrink-0 px-4 py-2 rounded ${isSelected ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'} transition">
                        <div class="text-xs ${isSelected ? 'text-white' : 'text-gray-400'}">${i === mondayOffset ? 'ä»Šå¤©' : 'å‘¨' + dayLabels[i]}</div>
                        <div class="text-sm font-semibold">${pad(d.getDate())}</div>
                    </button>
                `;
            }
            weekTabs.innerHTML = html;
        }
        
        // æ—¥å†ç­›é€‰
        function filterCalendar(filter) {
            calendarFilter = filter;
            document.querySelectorAll('.calendar-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            event.target.classList.remove('bg-gray-700');
            event.target.classList.add('bg-blue-600');
            renderEconomicCalendar();
        }
        
        // æ”¹å˜æ—¥æœŸ
        function changeCalendarDate(days) {
            currentCalendarDate.setDate(currentCalendarDate.getDate() + days);
            loadEconomicData();
        }
        
        // è®¾ç½®ä¸ºä»Šå¤©
        function setCalendarToday() {
            currentCalendarDate = new Date();
            loadEconomicData();
        }
        
        // è®¾ç½®ç‰¹å®šæ—¥æœŸ
        function setCalendarDate(dateStr) {
            currentCalendarDate = new Date(dateStr);
            loadEconomicData();
        }

        // ç”¨æˆ·ç³»ç»ŸçŠ¶æ€
        let isLoggedIn = false;
        let isMember = false;
        let userType = 'guest'; // guest, user, member
        
        // ç”¨æˆ·æ¯æ—¥å‘èµ·é™åˆ¶
        let userStats = {
            rewardPredictionsToday: 0,  // ä»Šå¤©å‘èµ·çš„æœ‰å¥–é¢„æµ‹æ•°ï¼ˆä¼šå‘˜ä¸“å±ï¼‰
            freePredictionsToday: 0,     // ä»Šå¤©å‘èµ·çš„æ— å¥–é¢„æµ‹æ•°ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
            lastResetDate: new Date().toDateString(),  // ä¸Šæ¬¡é‡ç½®æ—¥æœŸ
            platformFund: 0,  // å¹³å°ç´¯è®¡æ¿€åŠ±åŸºé‡‘
            weeklyContributions: []  // æœ¬å‘¨è´¡çŒ®è®°å½•
        };
        
        // ç”¨æˆ·æƒé™é…ç½®
        const USER_PERMISSIONS = {
            guest: {
                canViewMarket: true,
                canViewNews: true,
                canViewCalendar: true,
                canPost: false,
                canComment: false,
                canCreateFreePrediction: false,
                canCreateRewardPrediction: false,
                canVote: false,
                freePredictionsPerDay: 0,
                rewardPredictionsPerDay: 0
            },
            user: {
                canViewMarket: true,
                canViewNews: true,
                canViewCalendar: true,
                canPost: true,
                canComment: true,
                canCreateFreePrediction: true,
                canCreateRewardPrediction: false,
                canVote: true,
                freePredictionsPerDay: 3,
                rewardPredictionsPerDay: 0
            },
            member: {
                canViewMarket: true,
                canViewNews: true,
                canViewCalendar: true,
                canPost: true,
                canComment: true,
                canCreateFreePrediction: true,
                canCreateRewardPrediction: true,
                canVote: true,
                freePredictionsPerDay: 10,
                rewardPredictionsPerDay: 3
            }
        };
        
        // æ£€æŸ¥ç”¨æˆ·æƒé™
        function checkPermission(permission) {
            return USER_PERMISSIONS[userType][permission] || false;
        }
        
        // è·å–æ¯æ—¥é™åˆ¶
        function getDailyLimit(type) {
            if (type === 'free') {
                return USER_PERMISSIONS[userType].freePredictionsPerDay;
            } else if (type === 'reward') {
                return USER_PERMISSIONS[userType].rewardPredictionsPerDay;
            }
            return 0;
        }
        
        // æ£€æŸ¥æ¯æ—¥é™åˆ¶
        function checkDailyLimit(type) {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
            const today = new Date().toDateString();
            if (userStats.lastResetDate !== today) {
                userStats.freePredictionsToday = 0;
                userStats.rewardPredictionsToday = 0;
                userStats.lastResetDate = today;
                saveUserStats();
            }
            
            if (type === 'free') {
                return userStats.freePredictionsToday < getDailyLimit('free');
            } else if (type === 'reward') {
                return userStats.rewardPredictionsToday < getDailyLimit('reward');
            }
            return false;
        }
        
        // å¢åŠ ä½¿ç”¨æ¬¡æ•°
        function incrementDailyUsage(type) {
            if (type === 'free') {
                userStats.freePredictionsToday++;
            } else if (type === 'reward') {
                userStats.rewardPredictionsToday++;
            }
            saveUserStats();
        }
        
        // ä¿å­˜ç”¨æˆ·ç»Ÿè®¡
        function saveUserStats() {
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }
        
        // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
        function loadUserStats() {
            const saved = localStorage.getItem('userStats');
            if (saved) {
                userStats = JSON.parse(saved);
            }
        }

        let newsData = [];
        let currentNewsFilter = '';
        let currentNewsPage = 1;
        let newsHasMore = true;
        let isLoadingNews = false;
        
        // ä¸­æ–‡å…³é”®è¯æ˜ å°„ - æ‰©å±•ç‰ˆ
        const translateKeywords = {
            // ä¸»è¦åŠ å¯†è´§å¸
            'Bitcoin': 'æ¯”ç‰¹å¸', 'BTC': 'æ¯”ç‰¹å¸',
            'Ethereum': 'ä»¥å¤ªåŠ', 'ETH': 'ä»¥å¤ªåŠ',
            'Binance Coin': 'å¸å®‰å¸', 'BNB': 'å¸å®‰å¸',
            'Ripple': 'ç‘æ³¢å¸', 'XRP': 'ç‘æ³¢å¸',
            'Cardano': 'è‰¾è¾¾å¸', 'ADA': 'è‰¾è¾¾å¸',
            'Solana': 'Solana', 'SOL': 'Solana',
            'Polkadot': 'æ³¢å¡', 'DOT': 'æ³¢å¡',
            'Dogecoin': 'ç‹—ç‹—å¸', 'DOGE': 'ç‹—ç‹—å¸',
            'Polygon': 'Polygon', 'MATIC': 'Polygon',
            'Avalanche': 'é›ªå´©', 'AVAX': 'é›ªå´©',
            'Chainlink': 'Chainlink', 'LINK': 'Chainlink',
            'Litecoin': 'è±ç‰¹å¸', 'LTC': 'è±ç‰¹å¸',
            'Tether': 'æ³°è¾¾å¸', 'USDT': 'USDT',
            'USD Coin': 'USDC', 'USDC': 'USDC',
            'Shiba Inu': 'æŸ´çŠ¬å¸', 'SHIB': 'æŸ´çŠ¬å¸',
            
            // åŸºç¡€æœ¯è¯­
            'cryptocurrency': 'åŠ å¯†è´§å¸', 'crypto': 'åŠ å¯†è´§å¸',
            'blockchain': 'åŒºå—é“¾', 'price': 'ä»·æ ¼',
            'market': 'å¸‚åœº', 'trading': 'äº¤æ˜“',
            'exchange': 'äº¤æ˜“æ‰€', 'wallet': 'é’±åŒ…',
            'token': 'ä»£å¸', 'coin': 'å¸',
            'altcoin': 'å±±å¯¨å¸', 'stablecoin': 'ç¨³å®šå¸',
            'DeFi': 'DeFi', 'NFT': 'NFT',
            'mining': 'æŒ–çŸ¿', 'miner': 'çŸ¿å·¥',
            'hash': 'å“ˆå¸Œ', 'node': 'èŠ‚ç‚¹',
            'consensus': 'å…±è¯†', 'protocol': 'åè®®',
            
            // å¸‚åœºæœ¯è¯­
            'bull market': 'ç‰›å¸‚', 'bull': 'ç‰›å¸‚', 'bullish': 'çœ‹æ¶¨',
            'bear market': 'ç†Šå¸‚', 'bear': 'ç†Šå¸‚', 'bearish': 'çœ‹è·Œ',
            'surge': 'é£™å‡', 'soar': 'é£™å‡', 'skyrocket': 'æš´æ¶¨',
            'crash': 'æš´è·Œ', 'plunge': 'æš´è·Œ', 'collapse': 'å´©ç›˜',
            'rally': 'åå¼¹', 'rebound': 'åå¼¹', 'recover': 'æ¢å¤',
            'drop': 'ä¸‹è·Œ', 'fall': 'ä¸‹è·Œ', 'decline': 'ä¸‹è·Œ',
            'rise': 'ä¸Šæ¶¨', 'gain': 'ä¸Šæ¶¨', 'increase': 'å¢é•¿',
            'pump': 'æ‹‰ç›˜', 'dump': 'ç ¸ç›˜',
            'volatility': 'æ³¢åŠ¨æ€§', 'volatile': 'æ³¢åŠ¨',
            'correction': 'å›è°ƒ', 'dip': 'å›è°ƒ',
            'breakout': 'çªç ´', 'resistance': 'é˜»åŠ›ä½',
            'support': 'æ”¯æ’‘ä½', 'trend': 'è¶‹åŠ¿',
            'volume': 'æˆäº¤é‡', 'liquidity': 'æµåŠ¨æ€§',
            'market cap': 'å¸‚å€¼', 'marketcap': 'å¸‚å€¼',
            'capitalization': 'å¸‚å€¼',
            
            // äº¤æ˜“æœ¯è¯­
            'buy': 'ä¹°å…¥', 'sell': 'å–å‡º', 'hold': 'æŒæœ‰',
            'long': 'åšå¤š', 'short': 'åšç©º',
            'leverage': 'æ æ†', 'margin': 'ä¿è¯é‡‘',
            'futures': 'æœŸè´§', 'options': 'æœŸæƒ',
            'spot': 'ç°è´§', 'derivatives': 'è¡ç”Ÿå“',
            'order': 'è®¢å•', 'bid': 'ä¹°å•', 'ask': 'å–å•',
            'limit order': 'é™ä»·å•', 'market order': 'å¸‚ä»·å•',
            'stop loss': 'æ­¢æŸ', 'take profit': 'æ­¢ç›ˆ',
            
            // æŠ€æœ¯æœ¯è¯­
            'smart contract': 'æ™ºèƒ½åˆçº¦', 'contract': 'åˆçº¦',
            'decentralized': 'å»ä¸­å¿ƒåŒ–', 'centralized': 'ä¸­å¿ƒåŒ–',
            'peer-to-peer': 'ç‚¹å¯¹ç‚¹', 'P2P': 'ç‚¹å¯¹ç‚¹',
            'consensus mechanism': 'å…±è¯†æœºåˆ¶',
            'proof of work': 'å·¥ä½œé‡è¯æ˜', 'PoW': 'å·¥ä½œé‡è¯æ˜',
            'proof of stake': 'æƒç›Šè¯æ˜', 'PoS': 'æƒç›Šè¯æ˜',
            'fork': 'åˆ†å‰', 'hard fork': 'ç¡¬åˆ†å‰', 'soft fork': 'è½¯åˆ†å‰',
            'halving': 'å‡åŠ', 'airdrop': 'ç©ºæŠ•',
            'staking': 'è´¨æŠ¼', 'yield farming': 'æµåŠ¨æ€§æŒ–çŸ¿',
            'gas fee': 'Gasè´¹', 'transaction fee': 'äº¤æ˜“è´¹',
            
            // ç›‘ç®¡å’Œæ–°é—»
            'regulation': 'ç›‘ç®¡', 'regulatory': 'ç›‘ç®¡',
            'SEC': 'ç¾å›½è¯åˆ¸äº¤æ˜“å§”å‘˜ä¼š', 'CFTC': 'ç¾å›½å•†å“æœŸè´§äº¤æ˜“å§”å‘˜ä¼š',
            'ban': 'ç¦ä»¤', 'approve': 'æ‰¹å‡†', 'approval': 'æ‰¹å‡†',
            'ETF': 'ETF', 'institutional': 'æœºæ„',
            'adoption': 'é‡‡ç”¨', 'mainstream': 'ä¸»æµ',
            'investment': 'æŠ•èµ„', 'investor': 'æŠ•èµ„è€…',
            'whale': 'å·¨é²¸', 'retail': 'æ•£æˆ·',
            'FUD': 'FUD', 'FOMO': 'FOMO',
            'scam': 'éª—å±€', 'hack': 'é»‘å®¢æ”»å‡»', 'hacked': 'è¢«é»‘',
            'security': 'å®‰å…¨', 'vulnerability': 'æ¼æ´',
            
            // åŠ¨ä½œå’ŒçŠ¶æ€
            'launch': 'æ¨å‡º', 'release': 'å‘å¸ƒ',
            'announce': 'å®£å¸ƒ', 'announcement': 'å…¬å‘Š',
            'update': 'æ›´æ–°', 'upgrade': 'å‡çº§',
            'integrate': 'é›†æˆ', 'integration': 'é›†æˆ',
            'partner': 'åˆä½œ', 'partnership': 'åˆä½œ',
            'acquire': 'æ”¶è´­', 'acquisition': 'æ”¶è´­',
            'expand': 'æ‰©å±•', 'expansion': 'æ‰©å¼ ',
            'develop': 'å¼€å‘', 'development': 'å¼€å‘',
            
            // æ—¶é—´å’Œæ•°é‡
            'today': 'ä»Šå¤©', 'yesterday': 'æ˜¨å¤©',
            'week': 'å‘¨', 'month': 'æœˆ', 'year': 'å¹´',
            'daily': 'æ¯æ—¥', 'weekly': 'æ¯å‘¨', 'monthly': 'æ¯æœˆ',
            'billion': 'åäº¿', 'million': 'ç™¾ä¸‡',
            'thousand': 'åƒ', 'trillion': 'ä¸‡äº¿',
            
            // å…¶ä»–å¸¸ç”¨è¯
            'new': 'æ–°', 'latest': 'æœ€æ–°',
            'major': 'ä¸»è¦', 'significant': 'é‡å¤§',
            'record': 'åˆ›çºªå½•', 'historic': 'å†å²æ€§',
            'massive': 'å¤§è§„æ¨¡', 'huge': 'å·¨å¤§',
            'top': 'é¡¶çº§', 'leading': 'é¢†å…ˆ',
            'popular': 'çƒ­é—¨', 'trending': 'çƒ­é—¨',
            'analysis': 'åˆ†æ', 'report': 'æŠ¥å‘Š',
            'data': 'æ•°æ®', 'chart': 'å›¾è¡¨',
            'prediction': 'é¢„æµ‹', 'forecast': 'é¢„æµ‹',
            'expert': 'ä¸“å®¶', 'analyst': 'åˆ†æå¸ˆ',
            'CEO': 'CEO', 'founder': 'åˆ›å§‹äºº',
            'company': 'å…¬å¸', 'platform': 'å¹³å°',
            'network': 'ç½‘ç»œ', 'ecosystem': 'ç”Ÿæ€ç³»ç»Ÿ',
            'community': 'ç¤¾åŒº', 'user': 'ç”¨æˆ·',
            'global': 'å…¨çƒ', 'worldwide': 'å…¨çƒ',
            'industry': 'è¡Œä¸š', 'sector': 'é¢†åŸŸ'
            , 'Revolutionary': 'é©å‘½æ€§'
            , 'Virtual Asset': 'è™šæ‹Ÿèµ„äº§'
            , 'Reforms': 'æ”¹é©'
            , 'University': 'å¤§å­¦'
            , 'Endowments': 'æèµ åŸºé‡‘'
            , 'Valuation': 'ä¼°å€¼'
            , 'Arbitrage Strategy': 'å¥—åˆ©ç­–ç•¥'
            , 'Arbitrage': 'å¥—åˆ©'
            , 'Annual Returns': 'å¹´åº¦å›æŠ¥'
            , 'Raises': 'èèµ„'
            , 'Series C': 'Cè½®'
            , 'Series B': 'Bè½®'
            , 'Series A': 'Aè½®'
            , 'South Korean': 'éŸ©å›½'
            , 'Climbs': 'ä¸Šæ¶¨'
            , 'Trade': 'äº¤æ˜“'
        };
        
        // å¢å¼ºçš„ç¿»è¯‘å‡½æ•°
        function translateText(text) {
            if (!text) return text;
            
            let translated = text;
            
            // æŒ‰è¯é•¿åº¦æ’åºï¼Œä¼˜å…ˆåŒ¹é…é•¿è¯ç»„
            const sortedKeys = Object.keys(translateKeywords).sort((a, b) => b.length - a.length);
            
            for (const key of sortedKeys) {
                const value = translateKeywords[key];
                // ä½¿ç”¨å•è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…éƒ¨åˆ†åŒ¹é…
                const regex = new RegExp(`\\b${key}\\b`, 'gi');
                translated = translated.replace(regex, value);
            }
            
            // æ¸…ç†å¤šä½™ç©ºæ ¼
            translated = translated.replace(/\s+/g, ' ').trim();
            
            return translated;
        }
        
        // åˆ†ææƒ…ç»ª
        function analyzeSentiment(text) {
            const bullish = ['surge', 'rally', 'bull', 'rise', 'gain', 'high', 'up', 'growth'];
            const bearish = ['crash', 'drop', 'bear', 'fall', 'decline', 'down', 'loss', 'low'];
            const lower = text.toLowerCase();
            const bullCount = bullish.filter(w => lower.includes(w)).length;
            const bearCount = bearish.filter(w => lower.includes(w)).length;
            return bullCount > bearCount ? 'bullish' : bearCount > bullCount ? 'bearish' : 'neutral';
        }
        
        // åŠ è½½çœŸå®æ–°é—»ï¼ˆåˆ†é¡µ + å¯é€‰åˆ†ç±»ï¼‰
        async function loadNews(page = 1, category = '') {
            try {
                isLoadingNews = true;
                const params = new URLSearchParams();
                params.set('limit', '20');
                params.set('page', String(page));
                if (category) params.set('category', category);
                const response = await fetch(`${API_URL}/api/news?${params.toString()}`);
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                const list = (data.data || []);
                const mapped = list.map((news) => ({
                    id: news.id,
                    title: translateText(news.title),
                    content: translateText(news.body).substring(0, 150),
                    category: news.category || 'realtime',
                    sentiment: news.sentiment || analyzeSentiment((news.title || '') + ' ' + (news.body || '')),
                    source: news.source,
                    time: formatNewsTime(news.published_on),
                    views: Math.floor(Math.random() * 3000) + 500
                }));
                if (page === 1) {
                    newsData = mapped;
                } else {
                    newsData = newsData.concat(mapped);
                }
                currentNewsPage = page;
                newsHasMore = data.hasMore !== undefined ? !!data.hasMore : (mapped.length >= 20);
                renderNews(category);
            } catch (error) {
                console.error('Error loading news:', error);
            } finally {
                isLoadingNews = false;
            }
        }
        
        function formatNewsTime(timestamp) {
            const d = new Date(timestamp * 1000);
            const now = new Date();
            const sameDay = d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
            const pad = (n) => String(n).padStart(2, '0');
            if (sameDay) return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        // posts å˜é‡å·²åœ¨åé¢çš„ç¤¾åŒºåŠŸèƒ½ä¸­å®šä¹‰

        let predictions = [];

        async function loadPredictionsFromApi() {
            try {
                const res = await fetch(`${API_URL}/api/predictions`);
                const json = await res.json();
                const list = (json.data || []);
                predictions = list.map(pred => ({
                    id: pred._id,
                    creator: pred.creatorId?.username || 'åŒ¿å',
                    title: pred.title,
                    desc: pred.description || 'æ— æè¿°',
                    options: pred.options.map(opt => ({
                        text: opt.text,
                        votes: opt.votes.length,
                        voted: (typeof currentUser !== 'undefined' && currentUser) ? opt.votes.includes(currentUser.id) : false,
                        userVoted: (typeof currentUser !== 'undefined' && currentUser) ? opt.votes.includes(currentUser.id) : false
                    })),
                    hasReward: !!pred.hasReward,
                    rewardPerPerson: pred.rewardPerPerson || 0,
                    totalPool: pred.totalPool || 0,
                    creatorReward: pred.creatorReward || 0,
                    platformFee: pred.platformFee || 0,
                    winnerPool: pred.winnerPool || 0,
                    deadline: 'è¿›è¡Œä¸­',
                    status: pred.status || 'active'
                }));
                renderPredictions();
            } catch (e) {
                console.error('åŠ è½½é¢„æµ‹å¤±è´¥:', e);
            }
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(page, event) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + '-page').classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('bg-blue-600'));
            if (event && event.target) {
                event.target.classList.add('bg-blue-600');
            }
            
            // åˆ‡æ¢åˆ°æ–°é—»é¡µé¢æ—¶åŠ è½½æ•°æ®
            if (page === 'news' && newsData.length === 0) {
                loadNews(1, currentNewsFilter);
            }
            if (page === 'predictions') {
                loadPredictionsFromApi();
            }
        }

        // åŠ è½½çœŸå®åŠ å¯†è´§å¸æ•°æ®
        async function loadCryptoPrices() {
            try {
                const response = await fetch(
                    `${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false&price_change_percentage=24h`,
                    { timeout: 5000 }
                );
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                cryptoData = data.map(coin => ({
                    id: coin.id,
                    symbol: coin.symbol.toUpperCase(),
                    name: coin.name,
                    price: coin.current_price,
                    change: coin.price_change_percentage_24h,
                    marketCap: coin.market_cap / 1e9,
                    volume: coin.total_volume / 1e9,
                    high24h: coin.high_24h,
                    low24h: coin.low_24h,
                    liquidationUsd24h: null,
                    openInterestUsd: null
                }));
                await loadDerivativesMetrics();
                renderCrypto();
            } catch (error) {
                console.error('Error loading crypto prices:', error);
                // ä½¿ç”¨åå¤‡æ•°æ®
                cryptoData = [
                    { id: 'bitcoin', symbol: 'BTC', name: 'Bitcoin', price: 43250.50, change: 2.5, marketCap: 845.2, volume: 28.5, high24h: 43800, low24h: 42100 },
                    { id: 'ethereum', symbol: 'ETH', name: 'Ethereum', price: 2280.75, change: -1.2, marketCap: 274.3, volume: 15.2, high24h: 2320, low24h: 2250 },
                    { id: 'binancecoin', symbol: 'BNB', name: 'BNB', price: 315.20, change: 3.8, marketCap: 48.5, volume: 1.8, high24h: 320, low24h: 305 },
                    { id: 'solana', symbol: 'SOL', name: 'Solana', price: 98.45, change: 5.2, marketCap: 42.1, volume: 2.5, high24h: 102, low24h: 95 },
                    { id: 'ripple', symbol: 'XRP', name: 'XRP', price: 0.62, change: -0.8, marketCap: 33.8, volume: 1.2, high24h: 0.64, low24h: 0.61 },
                    { id: 'cardano', symbol: 'ADA', name: 'Cardano', price: 0.58, change: 1.5, marketCap: 20.5, volume: 0.8, high24h: 0.59, low24h: 0.57 },
                    { id: 'dogecoin', symbol: 'DOGE', name: 'Dogecoin', price: 0.085, change: -2.1, marketCap: 12.1, volume: 0.6, high24h: 0.088, low24h: 0.083 },
                    { id: 'polkadot', symbol: 'DOT', name: 'Polkadot', price: 7.25, change: 0.5, marketCap: 9.8, volume: 0.4, high24h: 7.35, low24h: 7.15 },
                    { id: 'polygon', symbol: 'MATIC', name: 'Polygon', price: 0.92, change: 4.2, marketCap: 8.5, volume: 0.5, high24h: 0.95, low24h: 0.88 },
                    { id: 'avalanche', symbol: 'AVAX', name: 'Avalanche', price: 38.50, change: -1.5, marketCap: 14.2, volume: 0.7, high24h: 39.5, low24h: 37.8 }
                ];
                renderCrypto();
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                document.querySelector('.text-green-400').textContent = 'âš ï¸ æ¼”ç¤ºæ•°æ®ï¼šAPI è¿æ¥å¤±è´¥ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®';
            }
        }

        // æ¸²æŸ“è¡Œæƒ…è¡¨æ ¼
        function renderCrypto() {
            const tbody = document.getElementById('crypto-table');
            tbody.innerHTML = cryptoData.map((coin, i) => `
                <tr class="border-t border-gray-700 hover:bg-gray-750 transition cursor-pointer">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-gray-400 font-medium">#${i+1}</span>
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${getGradient(coin.symbol)} flex items-center justify-center text-white font-bold text-sm">
                                ${coin.symbol[0]}
                            </div>
                            <div>
                                <div class="font-semibold">${coin.name}</div>
                                <div class="text-xs text-gray-400">${coin.symbol}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="font-mono font-semibold text-lg">$${coin.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="text-xs text-gray-400">â‰ˆ Â¥${(coin.price * 7.2).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="inline-flex items-center px-2 py-1 rounded ${coin.change >= 0 ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}">
                            <span class="font-semibold">${coin.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(coin.change).toFixed(2)}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-gray-300">$${coin.marketCap}B</div>
                        <div class="text-xs text-gray-500">å¸‚å€¼</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-gray-300">$${coin.volume}B</div>
                        <div class="text-xs text-gray-500">24hæˆäº¤é‡</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-gray-300">${coin.liquidationUsd24h != null ? ('$' + (coin.liquidationUsd24h >= 1e9 ? (coin.liquidationUsd24h/1e9).toFixed(2) + 'B' : coin.liquidationUsd24h >= 1e6 ? (coin.liquidationUsd24h/1e6).toFixed(2) + 'M' : coin.liquidationUsd24h.toFixed(0))) : '--'}</div>
                        <div class="text-xs text-gray-500">24hçˆ†ä»“é‡</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-gray-300">${coin.openInterestUsd != null ? ('$' + (coin.openInterestUsd >= 1e9 ? (coin.openInterestUsd/1e9).toFixed(2) + 'B' : coin.openInterestUsd >= 1e6 ? (coin.openInterestUsd/1e6).toFixed(2) + 'M' : coin.openInterestUsd.toFixed(0))) : '--'}</div>
                        <div class="text-xs text-gray-500">æŒä»“é‡</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-xs text-gray-400">
                            <div>é«˜: <span class="text-green-400">$${coin.high24h.toLocaleString()}</span></div>
                            <div>ä½: <span class="text-red-400">$${coin.low24h.toLocaleString()}</span></div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getGradient(symbol) {
            const gradients = {
                'BTC': 'from-orange-500 to-yellow-600',
                'ETH': 'from-blue-500 to-purple-600',
                'USDT': 'from-green-500 to-teal-600',
                'BNB': 'from-yellow-500 to-orange-600',
                'SOL': 'from-purple-500 to-pink-600',
                'XRP': 'from-blue-400 to-cyan-500',
                'ADA': 'from-blue-600 to-indigo-700'
            };
            return gradients[symbol] || 'from-gray-500 to-gray-600';
        }

        async function loadDerivativesMetrics() {
            try {
                const symbols = cryptoData.map(c => c.symbol).slice(0, 10).join(',');
                const res = await fetch(`${API_URL}/api/derivatives/metrics?symbols=${encodeURIComponent(symbols)}`);
                if (!res.ok) throw new Error('metrics fetch failed');
                const json = await res.json();
                const metrics = json.data || {};
                cryptoData = cryptoData.map(c => {
                    const m = metrics[c.symbol] || {};
                    return { ...c, liquidationUsd24h: m.liquidation24hUsd ?? c.liquidationUsd24h, openInterestUsd: m.openInterestUsd ?? c.openInterestUsd };
                });
            } catch (e) {}
        }

        setInterval(() => { loadCryptoPrices(); }, 30000);
        setInterval(() => { loadDerivativesMetrics().then(renderCrypto); }, 300000);

        // æ¸²æŸ“æ–°é—» - æ—¶é—´çº¿å¼å¸ƒå±€
        function renderNews(filter = '') {
            currentNewsFilter = filter;
            const filtered = filter ? newsData.filter(n => n.category === filter) : newsData;
            const sentimentColors = { 
                bullish: 'text-red-400', 
                bearish: 'text-green-400', 
                neutral: 'text-gray-400' 
            };
            const sentimentText = { 
                bullish: 'åˆ©ç©º', 
                bearish: 'åˆ©å¤š', 
                neutral: 'ä¸­æ€§' 
            };
            const categoryIcons = { 
                realtime: 'âš¡', 
                important: 'ğŸ“Œ', 
                breaking: 'ğŸ”¥' 
            };
            
            const newsList = document.getElementById('news-list');
            if (!newsList) return;
            if (!filtered.length) {
                newsList.innerHTML = `<div class="p-8 text-center text-gray-400">æš‚æ— æ–°é—»æ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œåˆ·æ–°â€æˆ–ç¨åé‡è¯•</div>`;
                return;
            }
            
            newsList.innerHTML = filtered.map((news, index) => `
                <div class="flex hover:bg-gray-750 transition cursor-pointer group">
                    <div class="w-24 flex-shrink-0 px-4 py-4 text-right">
                        <div class="text-sm text-gray-300 font-mono tabular-nums">${news.time}</div>
                    </div>
                    
                    <!-- å†…å®¹åˆ— -->
                    <div class="flex-1 px-6 py-4 border-l-2 ${index === 0 ? 'border-red-500' : 'border-gray-700'} group-hover:border-blue-500 transition">
                        <!-- æ ‡ç­¾å’Œæƒ…ç»ª -->
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-lg">${categoryIcons[news.category]}</span>
                            <span class="text-xs px-2 py-1 rounded ${index === 0 ? 'bg-red-900/30 text-red-400' : 'bg-gray-700 text-gray-300'}">
                                ${news.category === 'realtime' ? 'å¿«è®¯' : news.category === 'important' ? 'æ·±åº¦' : 'çªå‘'}
                            </span>
                            <span class="text-xs ${sentimentColors[news.sentiment]}">
                                ${sentimentText[news.sentiment]}
                            </span>
                        </div>
                        
                        <!-- æ ‡é¢˜ -->
                        <h3 class="text-base font-semibold mb-2 text-white group-hover:text-blue-400 transition leading-relaxed">
                            ${news.title}
                        </h3>
                        
                        <!-- å†…å®¹æ‘˜è¦ -->
                        <p class="text-sm text-gray-400 mb-3 leading-relaxed">
                            ${news.content}
                        </p>
                        
                        <!-- åº•éƒ¨ä¿¡æ¯ -->
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            <span>ğŸ“° ${news.source}</span>
                            <span>ğŸ‘ï¸ ${news.views.toLocaleString()}</span>
                            ${news.comments ? `<span>ğŸ’¬ ${news.comments}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterNews(category, event) {
            document.querySelectorAll('.news-tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-500');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            if (event && event.target) {
                event.target.classList.remove('border-transparent', 'text-gray-400');
                event.target.classList.add('border-blue-500', 'text-blue-500');
            }
            currentNewsFilter = category;
            currentNewsPage = 1;
            newsHasMore = true;
            loadNews(1, category);
        }
        
        function loadMoreNews() {
            if (isLoadingNews) return;
            if (!newsHasMore) {
                alert('å·²åˆ°åº•');
                return;
            }
            loadNews(currentNewsPage + 1, currentNewsFilter);
        }


        // ç¤¾åŒºå¸–å­æ•°æ®ï¼ˆæ”¹ä¸ºåç«¯è·å–ï¼Œå…¬å¼€å¯è¯»ï¼‰
        let posts = [];
        function formatCreatedAt(dt) { try { return new Date(dt).toLocaleString('zh-CN'); } catch { return ''; } }
        function normalizePost(p) {
            return {
                id: p.id || p._id || String(Date.now()),
                user: p.user || p.username || 'åŒ¿å',
                time: p.time || (p.createdAt ? formatCreatedAt(p.createdAt) : ''),
                content: p.content || '',
                likes: p.likes || 0,
                likedBy: Array.isArray(p.likedBy) ? p.likedBy : [],
                comments: Array.isArray(p.comments) ? p.comments : []
            };
        }
        async function loadCommunityPosts() {
            try {
                const res = await fetch(`${API_URL}/api/community/posts`);
                const json = await res.json();
                posts = Array.isArray(json.data) ? json.data.map(normalizePost) : [];
                renderPosts();
            } catch (e) {
                renderPosts();
            }
        }

        // æ¸²æŸ“å¸–å­åˆ—è¡¨ï¼ˆå¸¦è¯„è®ºåŠŸèƒ½ï¼‰
        function renderPosts() {
            const postsContainer = document.getElementById('posts-list');
            if (!postsContainer) return;
            
            postsContainer.innerHTML = posts.map(post => `
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center font-bold">
                            ${(post.user || '?')[0].toUpperCase()}
                        </div>
                        <div class="ml-3">
                            <div class="font-semibold">${post.user}</div>
                            <div class="text-sm text-gray-400">${post.time}</div>
                        </div>
                    </div>
                    <p class="text-gray-200 mb-4 whitespace-pre-wrap">${post.content}</p>
                    <div class="flex items-center space-x-6 text-gray-400 border-t border-gray-700 pt-4">
                        <button 
                            onclick="toggleLike('${post.id}')" 
                            class="flex items-center space-x-2 hover:text-blue-400 transition ${post.likedBy && post.likedBy.includes('current-user') ? 'text-blue-400' : ''}"
                        >
                            <span>${post.likedBy && post.likedBy.includes('current-user') ? 'ğŸ‘' : 'ğŸ‘ğŸ»'}</span>
                            <span>${post.likes}</span>
                        </button>
                        <button 
                            onclick="toggleComments('${post.id}')" 
                            class="flex items-center space-x-2 hover:text-blue-400 transition"
                        >
                            <span>ğŸ’¬</span>
                            <span>${post.comments.length}</span>
                        </button>
                        <button class="flex items-center space-x-2 hover:text-blue-400 transition">
                            <span>ğŸ”—</span>
                            <span>åˆ†äº«</span>
                        </button>
                    </div>
                    <div id="comments-${post.id}" class="hidden mt-4 border-t border-gray-700 pt-4">
                        <div class="space-y-3 mb-4">
                            ${post.comments.map(comment => `
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-semibold text-sm">${comment.user}</span>
                                        <span class="text-xs text-gray-400">${comment.time}</span>
                                    </div>
                                    <p class="text-gray-300 text-sm">${comment.content}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input 
                                type="text" 
                                id="comment-input-${post.id}"
                                placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." 
                                class="flex-1 bg-gray-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                onkeypress="if(event.key==='Enter') addComment('${post.id}')"
                            />
                            <button 
                                onclick="addComment('${post.id}')"
                                class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition text-sm"
                            >
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function createPost() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½å‘å¸–');
                showLoginModal();
                return;
            }
            
            // æ£€æŸ¥æƒé™
            if (!checkPermission('canPost')) {
                alert('æ‚¨æ²¡æœ‰å‘å¸–æƒé™');
                return;
            }
            
            const textarea = document.getElementById('new-post');
            const content = textarea.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }
            
            try {
                // ä½¿ç”¨ Base64 ç¼–ç ç”¨æˆ·åï¼Œé¿å…ä¸­æ–‡å­—ç¬¦å¯¼è‡´çš„ HTTP å¤´éƒ¨ç¼–ç é—®é¢˜
                const encodedUsername = btoa(encodeURIComponent(currentUser.username));
                
                const res = await fetch(`${API_URL}/api/community/posts`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-user-id': currentUser.id, 
                        'x-username': encodedUsername
                    },
                    body: JSON.stringify({ content })
                });
                const json = await res.json();
                if (!json.success) throw new Error(json.error || 'å‘å¸ƒå¤±è´¥');
                posts.unshift(normalizePost(json.data));
                textarea.value = '';
                renderPosts();
                showToast('âœ… å‘å¸ƒæˆåŠŸï¼');
            } catch (err) {
                console.error('å‘å¸ƒå¤±è´¥:', err);
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }
        }

        async function toggleLike(postId) {
            const post = posts.find(p => String(p.id) === String(postId));
            if (!post) return;
            if (!isLoggedIn) { showLoginModal(); return; }
            try {
                // ä½¿ç”¨ Base64 ç¼–ç ç”¨æˆ·å
                const encodedUsername = btoa(encodeURIComponent(currentUser.username));
                
                const res = await fetch(`${API_URL}/api/community/posts/${postId}/like`, {
                    method: 'POST',
                    headers: { 
                        'x-user-id': currentUser.id, 
                        'x-username': encodedUsername
                    }
                });
                const json = await res.json();
                if (json && json.success) {
                    post.likes = json.data.likes;
                    renderPosts();
                }
            } catch (e) {
                console.error('ç‚¹èµå¤±è´¥:', e);
            }
        }

        function toggleComments(postId) {
            const commentsDiv = document.getElementById(`comments-${postId}`);
            if (commentsDiv) {
                commentsDiv.classList.toggle('hidden');
                if (!commentsDiv.classList.contains('hidden')) {
                    setTimeout(() => {
                        const input = document.getElementById(`comment-input-${postId}`);
                        if (input) input.focus();
                    }, 100);
                }
            }
        }

        async function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }
            
            const post = posts.find(p => String(p.id) === String(postId));
            if (!post) return;
            if (!isLoggedIn) { showLoginModal(); return; }
            try {
                // ä½¿ç”¨ Base64 ç¼–ç ç”¨æˆ·å
                const encodedUsername = btoa(encodeURIComponent(currentUser.username));
                
                const res = await fetch(`${API_URL}/api/community/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-user-id': currentUser.id, 
                        'x-username': encodedUsername
                    },
                    body: JSON.stringify({ content })
                });
                const json = await res.json();
                if (json && json.success) {
                    post.comments.push(json.data);
                    input.value = '';
                    renderPosts();
                }
            } catch (e) { 
                console.error('è¯„è®ºå¤±è´¥:', e);
                alert('è¯„è®ºå¤±è´¥'); 
            }
            
            setTimeout(() => {
                const commentsDiv = document.getElementById(`comments-${postId}`);
                if (commentsDiv) commentsDiv.classList.remove('hidden');
            }, 100);
            
            showToast('âœ… è¯„è®ºæˆåŠŸï¼');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.style.animation = 'fadeIn 0.3s ease-out';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // å½“å‰é€‰æ‹©çš„å¥–é‡‘é‡‘é¢
        let selectedRewardAmount = 2;
        let isRewardPrediction = true;

        function toggleRewardType() {
            isRewardPrediction = !isRewardPrediction;
            const btn = document.getElementById('reward-toggle');
            const settings = document.getElementById('reward-settings');
            
            if (isRewardPrediction) {
                btn.textContent = 'ğŸ’° æœ‰å¥–é¢„æµ‹';
                btn.className = 'px-4 py-2 bg-green-600 rounded-lg text-sm font-semibold';
                settings.style.display = 'block';
            } else {
                btn.textContent = 'ğŸ¯ æ— å¥–é¢„æµ‹';
                btn.className = 'px-4 py-2 bg-gray-600 rounded-lg text-sm font-semibold';
                settings.style.display = 'none';
            }
        }

        function setRewardAmount(amount) {
            selectedRewardAmount = amount;
            document.querySelectorAll('.reward-btn').forEach((btn, i) => {
                if (i + 1 === amount) {
                    btn.className = 'reward-btn flex-1 px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 transition';
                } else {
                    btn.className = 'reward-btn flex-1 px-4 py-2 bg-gray-600 rounded hover:bg-blue-600 transition';
                }
            });
        }

        // æ£€æŸ¥å¹¶é‡ç½®æ¯æ—¥é™åˆ¶
        function checkDailyReset() {
            const today = new Date().toDateString();
            if (userStats.lastResetDate !== today) {
                userStats.rewardPredictionsToday = 0;
                userStats.freePredictionsToday = 0;
                userStats.lastResetDate = today;
            }
        }

        // è®¡ç®—å¥–é‡‘æ± 
        function calculateRewardPool(totalVotes, rewardPerPerson) {
            const totalPool = totalVotes * rewardPerPerson;
            const creatorReward = totalPool * 0.01;  // 1%
            const platformFee = totalPool * 0.04;    // 4%
            const operationFee = totalPool * 0.05;   // 5%
            const winnerPool = totalPool * 0.90;     // 90%
            
            return {
                totalPool,
                creatorReward,
                platformFee,
                operationFee,
                winnerPool
            };
        }

        // æ¸²æŸ“é¢„æµ‹
        function renderPredictions() {
            // æ›´æ–°é¢„æµ‹é¡µé¢çš„çŠ¶æ€æ˜¾ç¤º
            updatePredictionMemberStatus();
            updatePredictionNotice();
            updatePredictionStats();
            
            document.getElementById('predictions-list').innerHTML = predictions.map(pred => {
                const total = pred.options.reduce((sum, opt) => sum + opt.votes, 0);
                const userVoted = pred.options.some(opt => opt.voted);
                
                // åŠ¨æ€è®¡ç®—å¥–é‡‘æ± 
                let poolInfo = { totalPool: 0, winnerPool: 0, creatorReward: 0, platformFee: 0 };
                if (pred.hasReward) {
                    poolInfo = calculateRewardPool(total, pred.rewardPerPerson);
                }
                
                return `
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 shadow-xl hover:shadow-2xl transition">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-2xl">${pred.hasReward ? 'ğŸ’°' : 'ğŸ¯'}</span>
                                    <h3 class="text-xl font-bold">${pred.title}</h3>
                                    ${!pred.hasReward ? '<span class="px-2 py-1 bg-gray-600 rounded text-xs">æ— å¥–é¢„æµ‹</span>' : ''}
                                </div>
                                <p class="text-gray-400 text-sm">${pred.desc}</p>
                            </div>
                            <div class="ml-4 text-right">
                                ${pred.hasReward ? `
                                    <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-lg p-3 mb-2 shadow-lg">
                                        <div class="text-xs text-green-100 mb-1">æ€»å¥–æ± </div>
                                        <div class="text-xl font-bold text-white">${poolInfo.totalPool.toFixed(1)} USDT</div>
                                        <div class="text-xs text-green-100 mt-1">${pred.rewardPerPerson} USDT/äºº Ã— ${total}äºº</div>
                                    </div>
                                    <div class="bg-gray-700 rounded p-2 text-xs space-y-1">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">èƒœå‡ºå¥–åŠ±</span>
                                            <span class="text-green-400 font-semibold">${poolInfo.winnerPool.toFixed(1)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">å‘èµ·å¥–åŠ±</span>
                                            <span class="text-yellow-400 font-semibold">${poolInfo.creatorReward.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">æ¿€åŠ±åŸºé‡‘</span>
                                            <span class="text-blue-400 font-semibold">${poolInfo.platformFee.toFixed(2)}</span>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-gray-700 rounded-lg p-3 mb-2">
                                        <div class="text-sm text-gray-400">æ— å¥–é‡‘æ± </div>
                                        <div class="text-xs text-gray-500 mt-1">çº¯é¢„æµ‹æŠ•ç¥¨</div>
                                    </div>
                                `}
                                <div class="text-xs text-gray-400 flex items-center justify-end space-x-1 mt-2">
                                    <span>â°</span>
                                    <span>${pred.deadline}</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mb-4">
                            ${pred.options.map((opt, i) => {
                                const pct = total > 0 ? ((opt.votes / total) * 100).toFixed(1) : 0;
                                return `
                                    <div class="relative">
                                        <button 
                                            onclick="votePrediction('${pred.id}', ${i})" 
                                            class="w-full bg-gray-700 hover:bg-gray-600 rounded-lg p-4 transition ${opt.voted ? 'ring-2 ring-blue-500' : ''}"
                                        >
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center space-x-2">
                                                    ${opt.voted ? '<span class="text-blue-400">âœ“</span>' : ''}
                                                    <span class="font-semibold">${opt.text}</span>
                                                </div>
                                                <span class="text-blue-400 font-bold">${pct}%</span>
                                            </div>
                                            <div class="w-full bg-gray-600 rounded-full h-3 overflow-hidden">
                                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-2 flex items-center justify-between">
                                                <span>${opt.votes} äººæŠ•ç¥¨</span>
                                                ${pred.hasReward ? 
                                                    (isMember ? `<span class="text-green-400">ğŸ’° ${pred.rewardPerPerson} USDT</span>` : '<span class="text-yellow-400">ğŸ”’ ä¼šå‘˜å¯æŠ•ç¥¨</span>') : 
                                                    '<span class="text-blue-400">ğŸ‘† ç‚¹å‡»æŠ•ç¥¨</span>'}
                                            </div>
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${userVoted ? `
                            <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3 mb-4">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center space-x-2 text-green-400">
                                        <span>âœ“</span>
                                        <span>ä½ å·²æŠ•ç¥¨ï¼${pred.hasReward ? 'é¢„æµ‹å‡†ç¡®å°†è·å¾—å¥–åŠ±' : ''}</span>
                                    </div>
                                    ${pred.hasReward ? `<span class="text-yellow-400 font-semibold">å·²æŠ•å…¥ ${pred.rewardPerPerson} USDT</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        <div class="flex items-center justify-between text-sm text-gray-400 border-t border-gray-700 pt-4">
                            <div class="flex items-center space-x-4">
                                <span>ğŸ‘¤ ${pred.creator}</span>
                                <span>ğŸ“Š ${total} äººå‚ä¸</span>
                            </div>
                            <button class="text-blue-400 hover:text-blue-300">æŸ¥çœ‹è¯¦æƒ… â†’</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function votePrediction(predId, optionIndex) {
            if (!isLoggedIn || !currentUser) { alert('è¯·å…ˆç™»å½•'); showLoginModal(); return; }
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/predictions/vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ predictionId: predId, optionIndex, amount: 0, txHash: null })
                });
                const data = await res.json();
                if (!res.ok) { throw new Error(data.error || 'æŠ•ç¥¨å¤±è´¥'); }
                await loadPredictionsFromApi();
                alert('âœ… æŠ•ç¥¨æˆåŠŸï¼');
            } catch (e) {
                console.error('æŠ•ç¥¨å¤±è´¥:', e);
                alert('æŠ•ç¥¨å¤±è´¥: ' + e.message);
            }
        }

        function toggleCreatePrediction(isReward = false) {
            // æ˜¾ç¤ºåˆ›å»ºé¢„æµ‹è¡¨å•
            const createForm = document.getElementById('create-prediction');
            if (createForm) {
                createForm.classList.toggle('hidden');
                
                // æ ¹æ®ç±»å‹è®¾ç½®è¡¨å•
                if (!createForm.classList.contains('hidden')) {
                    // åˆå§‹åŒ–è¡¨å•
                    initPredictionForm(isReward ? 'reward' : 'free');
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updatePredictionStats();
                }
            }
        }

        async function createPrediction() {
            // 1. è·å–åŸºæœ¬ä¿¡æ¯
            const title = document.getElementById('pred-title').value.trim();
            const desc = document.getElementById('pred-desc').value.trim();
            
            if (!title) {
                alert('è¯·è¾“å…¥é¢„æµ‹æ ‡é¢˜');
                return;
            }
            
            // 2. è·å–é€‰é¡¹
            const options = [];
            for (let i = 1; i <= optionCount; i++) {
                const optionInput = document.getElementById(`option-${i}`);
                if (!optionInput) {
                    alert('é€‰é¡¹è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                
                const optionValue = optionInput.value.trim();
                if (!optionValue) {
                    alert(`è¯·å¡«å†™é€‰é¡¹ ${i}`);
                    return;
                }
                
                options.push({
                    text: optionValue,
                    votes: 0,
                    voted: false
                });
            }
            
            // 3. æ£€æŸ¥é¢„æµ‹ç±»å‹å’Œæƒé™
            const isRewardPrediction = currentPredictionType === 'reward';
            
            if (isRewardPrediction && !isMember) {
                alert('æœ‰å¥–é¢„æµ‹éœ€è¦ä¼šå‘˜æƒé™');
                showMembershipModal();
                return;
            }
            
            // 4. æ£€æŸ¥æ¯æ—¥é™åˆ¶
            checkDailyReset();
            
            if (isRewardPrediction) {
                if (userStats.rewardPredictionsToday >= 1) {
                    alert('âŒ æ¯å¤©åªèƒ½å‘èµ·1æ¬¡æœ‰å¥–é¢„æµ‹ï¼\n\nä½ ä»Šå¤©å·²ç»å‘èµ·è¿‡æœ‰å¥–é¢„æµ‹äº†ã€‚\næ˜å¤©å†æ¥å§ï¼');
                    return;
                }
            } else {
                if (userStats.freePredictionsToday >= 10) {
                    alert('âŒ æ¯å¤©æœ€å¤šå‘èµ·10æ¬¡æ— å¥–é¢„æµ‹ï¼\n\nä½ ä»Šå¤©å·²ç»è¾¾åˆ°ä¸Šé™äº†ã€‚\næ˜å¤©å†æ¥å§ï¼');
                    return;
                }
            }
            
            // 5. æäº¤åˆ°åç«¯
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/predictions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title,
                        description: desc || 'æ— æè¿°',
                        options: options.map(o => o.text),
                        hasReward: isRewardPrediction,
                        rewardPerPerson: isRewardPrediction ? selectedRewardAmount : 0,
                        deadline: new Date(Date.now() + 7*24*60*60*1000).toISOString()
                    })
                });
                const data = await response.json();
                if (!response.ok) { throw new Error(data.error || 'åˆ›å»ºå¤±è´¥'); }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
                return;
            }
            
            // 7. æ›´æ–°ç»Ÿè®¡
            if (isRewardPrediction) {
                userStats.rewardPredictionsToday++;
            } else {
                userStats.freePredictionsToday++;
            }
            localStorage.setItem('userStats', JSON.stringify(userStats));
            
            // 8. æ¸…ç©ºè¡¨å•
            document.getElementById('pred-title').value = '';
            document.getElementById('pred-desc').value = '';
            for (let i = 1; i <= optionCount; i++) {
                const input = document.getElementById(`option-${i}`);
                if (input) input.value = '';
            }
            
            // 9. åˆ·æ–°æ˜¾ç¤º
            toggleCreatePrediction();
            await loadPredictionsFromApi();
            updatePredictionStats();
            
            // 10. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const freeRemaining = getDailyLimit('free') - userStats.freePredictionsToday;
            const rewardRemaining = getDailyLimit('reward') - userStats.rewardPredictionsToday;
            
            alert(`âœ… é¢„æµ‹åˆ›å»ºæˆåŠŸï¼\n\næ ‡é¢˜ï¼š${title}\nç±»å‹ï¼š${isRewardPrediction ? 'æœ‰å¥–é¢„æµ‹' : 'æ— å¥–é¢„æµ‹'}\né€‰é¡¹ï¼š${options.map(opt => opt.text).join('ã€')}${isRewardPrediction ? `\næ¯äººæŠ•æ³¨ï¼š${selectedRewardAmount} USDT` : ''}\n\nä»Šæ—¥å‰©ä½™ï¼š\nâ€¢ æœ‰å¥–é¢„æµ‹ï¼š${rewardRemaining}æ¬¡\nâ€¢ æ— å¥–é¢„æµ‹ï¼š${freeRemaining}æ¬¡`);
        }

        // ========== è®¤è¯ç³»ç»Ÿå‡½æ•° ==========
        
        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }
        
        // å…³é—­è®¤è¯æ¨¡æ€æ¡†
        function closeAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-username').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-password-confirm').value = '';
        }
        
        // åˆ‡æ¢åˆ°æ³¨å†Œè¡¨å•
        function switchToRegister() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }
        
        // åˆ‡æ¢åˆ°ç™»å½•è¡¨å•
        function switchToLogin() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        }
        
        // å¤„ç†æ³¨å†Œ
        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            
            // éªŒè¯è¾“å…¥
            if (!username || username.length < 3 || username.length > 20) {
                alert('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´');
                return;
            }
            
            if (!email || !email.includes('@')) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            
            if (!password || password.length < 6) {
                alert('å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦');
                return;
            }
            
            if (password !== passwordConfirm) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            try {
                // è°ƒç”¨åç«¯ API æ³¨å†Œ
                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(data.error || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
                
                // æ³¨å†ŒæˆåŠŸï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œ token
                currentUser = {
                    id: data.user.id,
                    username: data.user.username,
                    email: data.user.email,
                    userType: data.user.isMember ? 'member' : 'user',
                    isMember: data.user.isMember,
                    avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user.username)}&background=random`
                };
                
                isLoggedIn = true;
                isMember = data.user.isMember;
                userType = data.user.isMember ? 'member' : 'user';
                
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('token', data.token);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('isLoggedIn', 'true');
                
                // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
                loadUserStats();
                
                // æ›´æ–° UI
                updateUserStatus();
                closeAuthModal();
                
                alert(`âœ… æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿ï¼Œ${currentUser.username}ï¼`);
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const usernameOrEmail = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!usernameOrEmail || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            try {
                // è°ƒç”¨åç«¯ API ç™»å½•
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        username: usernameOrEmail, 
                        password 
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(data.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
                
                // ç™»å½•æˆåŠŸï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œ token
                currentUser = {
                    id: data.user.id,
                    username: data.user.username,
                    email: data.user.email,
                    userType: data.user.isMember ? 'member' : 'user',
                    isMember: data.user.isMember,
                    avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user.username)}&background=random`
                };
                
                isLoggedIn = true;
                isMember = data.user.isMember;
                userType = data.user.isMember ? 'member' : 'user';
                
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('token', data.token);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('isLoggedIn', 'true');
                
                // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
                loadUserStats();
                
                // æ›´æ–° UI
                updateUserStatus();
                closeAuthModal();
                
                alert(`âœ… æ¬¢è¿å›æ¥ï¼Œ${currentUser.username}ï¼`);
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // é€€å‡ºç™»å½•
        function handleLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                currentUser = null;
                isLoggedIn = false;
                isMember = false;
                userType = 'guest';
                
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isLoggedIn');
                
                updateUserStatus();
                alert('å·²é€€å‡ºç™»å½•');
                
                // å¦‚æœåœ¨ç¤¾åŒºæˆ–é¢„æµ‹é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                renderPosts();
                renderPredictions();
            }
        }
        
        // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
        function updateUserStatus() {
            const statusDiv = document.getElementById('user-status');
            
            if (isLoggedIn && currentUser) {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${currentUser.avatar}" alt="${currentUser.username}" 
                            class="w-8 h-8 rounded-full border-2 border-gray-600">
                        <div class="flex flex-col">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-semibold">${currentUser.username}</span>
                                ${isMember ? '<span class="text-xs px-2 py-0.5 bg-gradient-to-r from-yellow-500 to-orange-500 rounded">ğŸ‘‘ ä¼šå‘˜</span>' : '<span class="text-xs px-2 py-0.5 bg-gray-700 rounded">æ™®é€šç”¨æˆ·</span>'}
                            </div>
                        </div>
                        <button onclick="handleLogout()" class="text-gray-400 hover:text-white text-sm">
                            é€€å‡º
                        </button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <button onclick="showLoginModal()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition text-sm">
                        ç™»å½• / æ³¨å†Œ
                    </button>
                `;
            }
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            const savedLoginStatus = localStorage.getItem('isLoggedIn');
            
            if (savedUser && savedLoginStatus === 'true') {
                currentUser = JSON.parse(savedUser);
                isLoggedIn = true;
                isMember = currentUser.isMember;
                userType = currentUser.isMember ? 'member' : 'user';
                loadUserStats();
                updateUserStatus();
            }
        }
        
        function showMembershipModal() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•è´¦å·');
                showLoginModal();
                return;
            }
            document.getElementById('membership-modal').style.display = 'flex';
        }

        function closeMembershipModal() {
            document.getElementById('membership-modal').style.display = 'none';
        }
        
        // ========== æ”¯ä»˜äºŒç»´ç åŠŸèƒ½ ==========
        
        // å¹³å°æ”¶æ¬¾åœ°å€ï¼ˆBSC é“¾ï¼‰
        const PLATFORM_PAYMENT_ADDRESS = '0xAC061A7998ee4EDe184248e19F4C3Afc5Eab53B9';
        
        // æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç 
        function showPaymentQRCode() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•è´¦å·');
                closeMembershipModal();
                showLoginModal();
                return;
            }
            
            // å…³é—­ä¼šå‘˜æ¨¡æ€æ¡†
            closeMembershipModal();
            
            // æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç æ¨¡æ€æ¡†
            document.getElementById('payment-qr-modal').style.display = 'flex';
            
            // ç”ŸæˆäºŒç»´ç 
            generatePaymentQRCode();
        }
        
        // ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
        function generatePaymentQRCode() {
            const qrcodeDiv = document.getElementById('payment-qrcode');
            
            // æ¸…ç©ºä¹‹å‰çš„äºŒç»´ç 
            qrcodeDiv.innerHTML = '';
            
            // ç”Ÿæˆæ–°çš„äºŒç»´ç 
            try {
                new QRCode(qrcodeDiv, {
                    text: PLATFORM_PAYMENT_ADDRESS,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                qrcodeDiv.innerHTML = '<div class="text-center text-red-500 text-sm">äºŒç»´ç ç”Ÿæˆå¤±è´¥</div>';
            }
        }
        
        // å…³é—­æ”¯ä»˜äºŒç»´ç æ¨¡æ€æ¡†
        function closePaymentQRModal() {
            document.getElementById('payment-qr-modal').style.display = 'none';
        }
        
        // å¤åˆ¶æ”¯ä»˜åœ°å€
        function copyPaymentAddress() {
            const addressInput = document.getElementById('payment-address');
            
            // é€‰ä¸­æ–‡æœ¬
            addressInput.select();
            addressInput.setSelectionRange(0, 99999); // ç§»åŠ¨ç«¯å…¼å®¹
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            try {
                // ç°ä»£æµè§ˆå™¨æ–¹æ³•
                navigator.clipboard.writeText(PLATFORM_PAYMENT_ADDRESS).then(() => {
                    showToast('âœ… åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    // é™çº§æ–¹æ¡ˆ
                    document.execCommand('copy');
                    showToast('âœ… åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            } catch (error) {
                // æœ€åçš„é™çº§æ–¹æ¡ˆ
                try {
                    document.execCommand('copy');
                    showToast('âœ… åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (e) {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶åœ°å€');
                }
            }
        }
        
        // ç¡®è®¤æ”¯ä»˜å®Œæˆ
        async function confirmPayment() {
            if (!isLoggedIn || !currentUser) {
                alert('è¯·å…ˆç™»å½•');
                closePaymentQRModal();
                showLoginModal();
                return;
            }
            
            const confirmed = confirm(
                'è¯·ç¡®è®¤æ‚¨å·²å®Œæˆæ‰«ç æ”¯ä»˜ï¼ˆ1 USDTï¼ŒBSCé“¾ï¼‰ã€‚\n\n' +
                'æ”¯ä»˜é€šå¸¸éœ€è¦å‡ åˆ†é’Ÿç¡®è®¤ã€‚ç¡®è®¤åè¯·è¾“å…¥è®¢å•å·ä»¥å¼€é€šä¼šå‘˜ã€‚'
            );
            
            if (!confirmed) return;
            
            const orderId = prompt('è¯·è¾“å…¥æ‰«ç æ”¯ä»˜æˆåŠŸåçš„è®¢å•å·');
            if (!orderId) return;
            
            try {
                const response = await fetch(`${API_URL}/api/membership/activate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ txHash: orderId, blockNumber: null })
                });
                const data = await response.json();
                if (!response.ok || !data.success) { throw new Error(data.error || 'æ¿€æ´»å¤±è´¥'); }
                closePaymentQRModal();
                isMember = true;
                currentUser.isMember = true;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUserStatus();
                renderPredictions();
                alert('âœ… ä¼šå‘˜å·²å¼€é€š');
            } catch (e) {
                alert('æ¿€æ´»å¤±è´¥: ' + e.message);
            }
        }
        
        // å‡çº§ä¸ºä¼šå‘˜
        function upgradToMember() {
            if (!currentUser) return;
            
            // æ›´æ–°ç”¨æˆ·çŠ¶æ€
            currentUser.isMember = true;
            currentUser.userType = 'member';
            isMember = true;
            userType = 'member';
            
            // æ›´æ–° localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].isMember = true;
                users[userIndex].userType = 'member';
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // æ›´æ–° UI
            updateUserStatus();
            renderPredictions();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showToast('ğŸ‰ æ­å–œæˆä¸ºä¼šå‘˜ï¼å·²è§£é”å…¨éƒ¨åŠŸèƒ½');
        }
        
        // Toast æç¤ºå‡½æ•°
        function showToast(message) {
            // åˆ›å»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 border border-gray-700';
            toast.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // ========== é¢„æµ‹ç±»å‹é€‰æ‹©åŠŸèƒ½ ==========
        
        // æ˜¾ç¤ºé¢„æµ‹ç±»å‹é€‰æ‹©æ¨¡æ€æ¡†
        function showPredictionTypeModal() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½å‘èµ·é¢„æµ‹');
                showLoginModal();
                return;
            }
            
            document.getElementById('prediction-type-modal').style.display = 'flex';
        }
        
        // å…³é—­é¢„æµ‹ç±»å‹é€‰æ‹©æ¨¡æ€æ¡†
        function closePredictionTypeModal() {
            document.getElementById('prediction-type-modal').style.display = 'none';
        }
        
        // é€‰æ‹©é¢„æµ‹ç±»å‹
        function selectPredictionType(type) {
            closePredictionTypeModal();
            
            if (type === 'free') {
                // æ— å¥–é¢„æµ‹
                if (!checkPermission('canCreateFreePrediction')) {
                    alert('æ‚¨æ²¡æœ‰å‘èµ·æ— å¥–é¢„æµ‹çš„æƒé™ï¼Œè¯·å…ˆç™»å½•');
                    showLoginModal();
                    return;
                }
                
                if (!checkDailyLimit('free')) {
                    const limit = getDailyLimit('free');
                    alert(`æ‚¨ä»Šå¤©çš„æ— å¥–é¢„æµ‹æ¬¡æ•°å·²ç”¨å®Œï¼\n\næ¯æ—¥é™åˆ¶ï¼š${limit}æ¬¡\nå·²ä½¿ç”¨ï¼š${userStats.freePredictionsToday}æ¬¡`);
                    return;
                }
                
                // æ˜¾ç¤ºæ— å¥–é¢„æµ‹åˆ›å»ºè¡¨å•
                toggleCreatePrediction(false);
                
            } else if (type === 'reward') {
                // æœ‰å¥–é¢„æµ‹
                if (!isMember) {
                    alert('æœ‰å¥–é¢„æµ‹éœ€è¦ä¼šå‘˜æƒé™\n\nè¯·å…ˆæˆä¸ºä¼šå‘˜è§£é”æ­¤åŠŸèƒ½');
                    showMembershipModal();
                    return;
                }
                
                if (!checkPermission('canCreateRewardPrediction')) {
                    alert('æ‚¨æ²¡æœ‰å‘èµ·æœ‰å¥–é¢„æµ‹çš„æƒé™');
                    return;
                }
                
                if (!checkDailyLimit('reward')) {
                    const limit = getDailyLimit('reward');
                    alert(`æ‚¨ä»Šå¤©çš„æœ‰å¥–é¢„æµ‹æ¬¡æ•°å·²ç”¨å®Œï¼\n\næ¯æ—¥é™åˆ¶ï¼š${limit}æ¬¡\nå·²ä½¿ç”¨ï¼š${userStats.rewardPredictionsToday}æ¬¡`);
                    return;
                }
                
                // æ˜¾ç¤ºæœ‰å¥–é¢„æµ‹åˆ›å»ºè¡¨å•
                toggleCreatePrediction(true);
            }
        }
        
        // æ›´æ–°é¢„æµ‹é¡µé¢çš„ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º
        function updatePredictionMemberStatus() {
            const statusDiv = document.getElementById('prediction-member-status');
            if (!statusDiv) return;
            
            if (isMember) {
                statusDiv.innerHTML = '<span class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-semibold">ğŸ‘‘ ä¼šå‘˜</span>';
            } else if (isLoggedIn) {
                statusDiv.innerHTML = '<button onclick="showMembershipModal()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg hover:from-blue-700 hover:to-purple-700 font-semibold">æˆä¸ºä¼šå‘˜</button>';
            } else {
                statusDiv.innerHTML = '';
            }
        }
        
        // ========== é¢„æµ‹è¡¨å•åŠŸèƒ½ ==========
        
        let currentPredictionType = 'free'; // 'free' æˆ– 'reward'
        let optionCount = 2; // é»˜è®¤2ä¸ªé€‰é¡¹
        
        // åˆ‡æ¢é¢„æµ‹ç±»å‹
        function switchPredictionType(type) {
            currentPredictionType = type;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const freeBtn = document.getElementById('free-type-btn');
            const rewardBtn = document.getElementById('reward-type-btn');
            const rewardSettings = document.getElementById('reward-settings-container');
            
            if (type === 'free') {
                freeBtn.classList.add('bg-blue-600');
                freeBtn.classList.remove('bg-gray-700');
                rewardBtn.classList.add('bg-gray-700');
                rewardBtn.classList.remove('bg-yellow-600');
                
                // éšè—å¥–é‡‘è®¾ç½®
                if (rewardSettings) {
                    rewardSettings.style.display = 'none';
                }
            } else {
                // æ£€æŸ¥ä¼šå‘˜æƒé™
                if (!isMember) {
                    alert('æœ‰å¥–é¢„æµ‹éœ€è¦ä¼šå‘˜æƒé™\n\nè¯·å…ˆæˆä¸ºä¼šå‘˜');
                    showMembershipModal();
                    // åˆ‡æ¢å›æ— å¥–é¢„æµ‹
                    switchPredictionType('free');
                    return;
                }
                
                freeBtn.classList.add('bg-gray-700');
                freeBtn.classList.remove('bg-blue-600');
                rewardBtn.classList.add('bg-yellow-600');
                rewardBtn.classList.remove('bg-gray-700');
                
                // æ˜¾ç¤ºå¥–é‡‘è®¾ç½®
                if (rewardSettings) {
                    rewardSettings.style.display = 'block';
                }
            }
        }
        
        // è®¾ç½®é€‰é¡¹æ•°é‡
        function setOptionCount(count) {
            optionCount = count;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.option-count-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            event.target.classList.add('bg-blue-600');
            event.target.classList.remove('bg-gray-700');
            
            // ç”Ÿæˆé€‰é¡¹è¾“å…¥æ¡†
            generateOptionInputs(count);
        }
        
        // ç”Ÿæˆé€‰é¡¹è¾“å…¥æ¡†
        function generateOptionInputs(count) {
            const container = document.getElementById('options-container');
            if (!container) return;
            
            let html = '';
            const placeholders = ['çº¢è‰²', 'é»‘è‰²', 'è“è‰²', 'ç™½è‰²', 'ç»¿è‰²'];
            
            for (let i = 1; i <= count; i++) {
                html += `
                    <div class="mb-3">
                        <label class="block text-sm text-gray-400 mb-1">é€‰é¡¹ ${i}</label>
                        <input id="option-${i}" type="text" 
                            placeholder="ä¾‹å¦‚ï¼š${placeholders[i-1] || 'é€‰é¡¹' + i}" 
                            class="w-full bg-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // åˆå§‹åŒ–é¢„æµ‹è¡¨å•
        function initPredictionForm(type = 'free') {
            currentPredictionType = type;
            optionCount = 2;
            
            // è®¾ç½®ç±»å‹
            switchPredictionType(type);
            
            // ç”Ÿæˆé»˜è®¤é€‰é¡¹
            generateOptionInputs(2);
        }
        
        // æ›´æ–°é¢„æµ‹ç»Ÿè®¡ä¿¡æ¯
        function updatePredictionStats() {
            const statsDiv = document.getElementById('prediction-stats');
            if (!statsDiv) return;
            
            if (!isLoggedIn) {
                statsDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300">è¯·å…ˆç™»å½•æŸ¥çœ‹ç»Ÿè®¡</span>
                    </div>
                `;
                return;
            }
            
            const freeLimit = getDailyLimit('free');
            const rewardLimit = getDailyLimit('reward');
            const freeUsed = userStats.freePredictionsToday || 0;
            const rewardUsed = userStats.rewardPredictionsToday || 0;
            
            statsDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-gray-300">ä»Šæ—¥å·²å‘èµ·ï¼š</span>
                    <div class="flex items-center space-x-4">
                        <span class="text-yellow-400">æœ‰å¥– ${rewardUsed}/${rewardLimit}</span>
                        <span class="text-blue-400">æ— å¥– ${freeUsed}/${freeLimit}</span>
                    </div>
                </div>
            `;
        }
        
        // æ›´æ–°é¢„æµ‹é¡µé¢çš„æƒé™æç¤º
        function updatePredictionNotice() {
            const noticeDiv = document.getElementById('prediction-notice');
            if (!noticeDiv) return;
            
            if (!isLoggedIn) {
                noticeDiv.innerHTML = `
                    <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">â„¹ï¸</span>
                            <div class="flex-1">
                                <div class="font-semibold text-blue-400 mb-1">ç™»å½•åå³å¯å‚ä¸</div>
                                <div class="text-sm text-gray-300">ç™»å½•åå¯å‘èµ·æ— å¥–é¢„æµ‹ã€å‚ä¸æŠ•ç¥¨ï¼Œæˆä¸ºä¼šå‘˜è¿˜èƒ½å‘èµ·æœ‰å¥–é¢„æµ‹ï¼</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!isMember) {
                noticeDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border border-yellow-500/50 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">ğŸ‘‘</span>
                            <div class="flex-1">
                                <div class="font-semibold text-yellow-400 mb-1">å‡çº§ä¼šå‘˜è§£é”æ›´å¤šåŠŸèƒ½</div>
                                <div class="text-sm text-gray-300">
                                    å½“å‰æƒé™ï¼šæ— å¥–é¢„æµ‹ ${userStats.freePredictionsToday}/${getDailyLimit('free')} æ¬¡<br>
                                    ä¼šå‘˜ç‰¹æƒï¼šæ— å¥–é¢„æµ‹ 10æ¬¡/å¤© + æœ‰å¥–é¢„æµ‹ 3æ¬¡/å¤©
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                noticeDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-green-900/30 to-teal-900/30 border border-green-500/50 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">âœ¨</span>
                            <div class="flex-1">
                                <div class="font-semibold text-green-400 mb-1">ä¼šå‘˜æƒé™å·²æ¿€æ´»</div>
                                <div class="text-sm text-gray-300">
                                    ä»Šæ—¥å‰©ä½™ï¼šæ— å¥–é¢„æµ‹ ${getDailyLimit('free') - userStats.freePredictionsToday}/${getDailyLimit('free')} æ¬¡ | 
                                    æœ‰å¥–é¢„æµ‹ ${getDailyLimit('reward') - userStats.rewardPredictionsToday}/${getDailyLimit('reward')} æ¬¡
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function becomeMember() {
            if (!currentUser) { alert('è¯·å…ˆç™»å½•'); closeMembershipModal(); return; }
            if (isMember) { alert('ä½ å·²ç»æ˜¯ä¼šå‘˜äº†ï¼'); closeMembershipModal(); return; }

            try {
                const orderId = prompt('è¯·è¾“å…¥æ‰«ç æ”¯ä»˜æˆåŠŸåçš„è®¢å•å·');
                if (!orderId) return;
                const response = await fetch(`${API_URL}/api/membership/activate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ txHash: orderId, blockNumber: null })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… æ­å–œæˆä¸ºä¼šå‘˜ï¼');
                    isMember = true;
                    currentUser.isMember = true;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    closeMembershipModal();
                    renderPredictions();
                    document.getElementById('member-status').innerHTML = '<span class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg font-semibold">ğŸ‘‘ ä¼šå‘˜</span>';
                    document.getElementById('member-notice').style.display = 'none';
                } else { throw new Error(data.error || 'æ¿€æ´»å¤±è´¥'); }

            } catch (error) {
                console.error('æ¿€æ´»å¤±è´¥:', error);
                alert('æ¿€æ´»å¤±è´¥: ' + error.message);
            }
        }
        
        // é’±åŒ…è¿æ¥åŠŸèƒ½
        async function connectWallet() {}
        
        function logout() { handleLogout(); }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() { /* å·²åœ¨ä¸Šæ–‡å®ç° */ }

        // æ›´æ–°å¹³å°åŸºé‡‘æ˜¾ç¤º
        function updatePlatformFund() {
            document.getElementById('platform-fund').textContent = userStats.platformFund.toFixed(2) + ' USDT';
        }

        // åˆå§‹åŒ–
        checkLoginStatus();  // æ£€æŸ¥ç™»å½•çŠ¶æ€
        loadCryptoPrices();  // åŠ è½½çœŸå®ä»·æ ¼æ•°æ®
        loadNews();          // åŠ è½½çœŸå®æ–°é—»æ•°æ®
        loadEconomicData();  // åŠ è½½çœŸå®ç»æµæ•°æ®
        loadCommunityPosts();
        renderPredictions();
        updatePlatformFund();
        showPage('market');
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('membership-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMembershipModal();
            }
        });
        
        document.getElementById('auth-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAuthModal();
            }
        });
        
        document.getElementById('payment-qr-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePaymentQRModal();
            }
        });
        
        document.getElementById('prediction-type-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePredictionTypeModal();
            }
        });

        const detailModalHtml = `
            <div id="calendar-detail-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
                <div class="bg-gray-900 rounded-lg p-6 w-full max-w-lg border border-gray-700">
                    <div id="calendar-detail-box"></div>
                    <div class="mt-6 text-right">
                        <button class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600" onclick="closeCalendarDetail()">å…³é—­</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', detailModalHtml);
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();
            
            // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
            loadUserStats();
            
            // åŠ è½½è¡Œæƒ…æ•°æ®
            loadCryptoPrices();
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(loadCryptoPrices, 30000);
            
            // åŠ è½½æ–°é—»æ•°æ®
            loadNews(1, currentNewsFilter);
            initNewsClock();
            
            // åŠ è½½ç»æµæ•°æ®
            loadEconomicData();
            
            // æ¸²æŸ“ç¤¾åŒºå¸–å­
            if (typeof renderPosts === 'function') {
                renderPosts();
            }
            
            loadPredictionsFromApi();
        });

        function initNewsClock() {
            const el = document.getElementById('news-date-time');
            if (!el) return;
            const dateSpan = el.children[0];
            const timeSpan = el.children[1];
            const update = () => {
                const now = new Date();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const pad = (n) => String(n).padStart(2, '0');
                dateSpan.textContent = `${month}æœˆ${day}æ—¥ Â· ä»Šå¤©`;
                timeSpan.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
            };
            update();
            setInterval(update, 1000);
        }
    </script>
</body>
</html>
